(()=>{"use strict";class e{constructor(e,t,i,s,a){this.type=e,this.HP=t,this.ATK=i,this.DEF=s,this.Gold=a}}class t extends e{constructor(e,t,i,s,a,r){super("chest",t,0,0,i),this.id=e,this.state=s,this.x=a,this.y=r,this.color,this.setColor(),this.serif,this.serifs=[],this.pattern,this.patterns=[],this.position,this.positions=[]}setColor(){switch(Math.floor(4*Math.random())){case 0:this.color="red";break;case 1:this.color="green";break;case 2:this.color="blue";break;default:this.color="black"}}get place(){return[this.x,this.y]}set place(e){[this.x,this.y]=e}get condition(){return[this.id,this.state,this.color,this.serif]}get up(){return[this.x+0,this.y+1]}get right(){return[this.x+1,this.y+0]}get down(){return[this.x+0,this.y-1]}get left(){return[this.x-1,this.y+0]}}class i{constructor(e,t,i){this.enemies=e,this.formX=t[0],this.formY=t[1],this.numberMimics=i,this.numberGimmicks=8,this.dateGimmicks=[]}setDifficulty(e){const t=this.formX*this.formY,i=Array(this.numberGimmicks).fill(0);let s=t;switch(e){case"easy":i.splice(7,1,Math.floor(t/5)),i.splice(1,1,Math.floor(t/4)),i.forEach((e=>s-=e)),i.splice(0,1,s);break;case"hard":i.splice(5,1,Math.floor(t/6)),i.splice(4,1,Math.floor(t/5)),i.splice(1,1,Math.floor(t/4)),i.forEach((e=>s-=e)),i.splice(0,1,s);break;case"expart":i.splice(7,1,Math.floor(t/6)),i.splice(6,1,Math.floor(t/6)),i.splice(5,1,Math.floor(t/6)),i.splice(4,1,Math.floor(t/5)),i.splice(3,1,Math.floor(t/5)),i.splice(2,1,Math.floor(t/5)),i.splice(1,1,Math.floor(t/4)),i.forEach((e=>s-=e)),i.splice(0,1,s);break;default:alert("error at dungeon.js 違法なversionです")}for(let e=0;e<i.length;e++)this["setGimmick"+(e+1)](i[e])}decideSerif(e){const t=this.getFreeEnemies();for(let i=e;i>0&&t.length>0;){const e=Math.floor(Math.random()*t.length),s=t[e];if(t.splice(e,1),s.serifs.length>0&&null==s.serif){const e=Math.floor(Math.random()*s.serifs.length);s.serif=s.serifs[e],s.pattern=s.patterns[e],s.position=s.positions[e],i--}}for(const e of this.enemies)for(const t of e)t.serifs.length=0,t.patterns.length=0,t.positions.length=0}setSerifs(e,t,i,s=!1,a=!1){if(null!=e.serif)return;const r=e.state;let o,n;"treasure"==r&&(o=i[0],n=i[1]),"mimic"==r&&(o=i[1],n=i[0]),e.serifs.push(i[2]+(t?o:n)),s&&e.patterns.push(s),a&&e.positions.push(a)}setGimmick1(e){if(e<1)return;const t=["downWard","rightSide","upWard","leftSide"],i=["上の宝箱は","右の宝箱は","下の宝箱は","左の宝箱は"];for(const e of this.getFreeEnemies()){const s=[e.down,e.right,e.up,e.left];for(let a=0;a<s.length;a++){const r=s[a][0],o=s[a][1];if(!this.inRoom(r,o))continue;const n="mimic"==this.enemies[r][o].state;this.setSerifs(e,n,["\nミミックだよ","\nミミックじゃないよ",i[a]],t[a],[s[a]])}}this.decideSerif(e)}setGimmick2(e){if(e<1)return;const t=["leftRow","downRow","rightRow","upRow"],i=["一番左の列に","一番上の列に","一番右の列に","一番下の列に"];let s,a;const r=[],o=[],n=this.formX-1,h=this.formY-1;for(let e=0;e<2;e++){const t=[];s=!1,a=0;for(let i=0;i<this.formY;i++)t.push([e*n,i]),"mimic"==this.enemies[e*n][i].state&&(a++,s=!0);o.push(t.concat()),r.push(s),this.dateGimmicks.push([a,0==e?"左の列":"右の列"]),t.length=0,s=!1,a=0;for(let i=0;i<this.formX;i++)t.push([i,e*h]),"mimic"==this.enemies[i][e*h].state&&(a++,s=!0);o.push(t.concat()),r.push(s),this.dateGimmicks.push([a,0==e?"上の列":"下の列"])}for(let e=0;e<t.length;e++)for(const s of this.getFreeEnemies())this.setSerifs(s,r[e],["\nミミックがいるよ","\nミミックはいないよ",i[e]],t[e],o[e]);this.decideSerif(e)}setGimmick3(e){if(e<1)return;const t=[];for(const e of this.enemies)for(const i of e)t.push(i.color);const i={red:"赤色の宝箱",green:"緑色の宝箱",blue:"青色の宝箱",black:"黒色の宝箱"},s=t.filter(((e,t,i)=>t===i.indexOf(e))),a=[];s.forEach((e=>a.push(i[e])));const r=[],o=[];for(let e=0;e<s.length;e++){let t=!1;const a=[];let n=0;for(const i of this.enemies)for(const r of i)r.color==s[e]&&(r.patterns.push(s[e]),a.push(r.place),"mimic"==r.state&&(t=!0,n++));this.dateGimmicks.push([n,i[`${s[e]}`]]),r.push(t),o.push(a)}for(let e=0;e<s.length;e++)for(const t of this.getFreeEnemies())this.setSerifs(t,r[e],["に\nミミックがいるよ","に\nミミックはいないよ",a[e],o[e]],s[e],o[e]);this.decideSerif(e)}setGimmick4(e){if(e<1)return;let t=!1,i=[];if(this.numberMimics>1){const s="nextTo";e:for(const e of this.enemies)for(const s of e)if("mimic"==s.state){if(i=i.filter(((e,t,i)=>t===i.indexOf(e))),t=i.some((e=>e.toString()==s.place.toString())),t)break e;i.push(s.down),i.push(s.right),i.push(s.up),i.push(s.left)}for(const e of this.getFreeEnemies())this.setSerifs(e,t,["があるよ","はないよ","上下左右で接している\nミミックの組"],s);this.decideSerif(e)}else this.setGimmick1(e)}setGimmick5(e){if(!(e<1))if(this.formX>2||this.formY>2){let t=!1;const i=[],s="corner";let a=0;for(let e=0;e<2;e++)for(let s=0;s<2;s++){const r=this.enemies[e*(this.formX-1)][s*(this.formY-1)];i.push([e*(this.formX-1),s*(this.formY-1)]),"mimic"==r.state&&(t=!0,a++)}this.dateGimmicks.push([a,"角の宝箱"]);for(let e of this.getFreeEnemies())this.setSerifs(e,t,["ミミックがいるよ","ミミックはいないよ","角にいる宝箱の中に\n"],s,i);this.decideSerif(e)}else this.setGimmick1(e)}setGimmick6(e){if(!(e<1))if(this.formX>2&&this.formY>2){let t=!1;const i=[],s="center";let a=0;for(let e=1;e<this.formX-1;e++)for(let s=1;s<this.formY-1;s++){const r=this.enemies[e][s];i.push([e,s]),"mimic"==r.state&&(t=!0,a++)}this.dateGimmicks.push([a,"中央の宝箱"]);for(let e of this.getFreeEnemies())this.setSerifs(e,t,["ミミックがいるよ","ミミックはいないよ","中央にいる宝箱の中に\n"],s,i);this.decideSerif(e)}else this.setGimmick1(e)}setGimmick7(e){if(!(e<1)){for(const e of this.getFreeEnemies())e.serifs.push("Zzz…"),e.patterns.push("sleeper");this.decideSerif(e)}}setGimmick8(e){if(e<1)return;const t=this.dateGimmicks,i=t.length,s=[];for(let e=0;e<i-1;e++)for(let a=e+1;a<i;a++)t[e][0]!=t[a][0]&&s.push([e,a]);if(0==s.length)return void this.setGimmick1(e);let a,r;const o=Math.floor(Math.random()*s.length);a=s[o][0],r=s[o][1];let n=!1;t[a][0]<t[r][0]&&(n=!0);const h=`${t[a][1]}より${t[r][1]}の方が\nミミックの数`;for(const e of this.getFreeEnemies())this.setSerifs(e,n,["が多いよ","は少ないよ",h],"pair");this.decideSerif(e)}getFreeEnemies(){const e=[];for(const t of this.enemies)for(const i of t)null==i.serif&&e.push(i);return e}inRoom(e,t){return 0<=e&&e<this.formX&&0<=t&&t<this.formY}}class s{constructor(e,t,i=1){this.enemies=e,this.formX=e.length,this.formY=e[0].length,this.numberMimics=t,this.renge=i,this.mimicRenge,this.mapExpected=[],this._answers=[]}setArray(e,t){e.length=0;const i=Array(this.formY).fill(t);for(let t=0;t<this.formX;t++)e.push(i.concat())}inStandard(){for(const e of this.enemies)for(const t of e)if(null==t.serif)return!1;return!0}checkReality(){if(!this.inStandard())return!1;const e=this.formX*this.formY,t=this.numberMimics;let i="M";t>e-t&&(i="T");const s="M"==i?t:e-t,a="M"==i?"treasure":"mimic",r="M"==i?"mimic":"treasure";let o=0;const n=e=>{this.experiment(a,r,e),this.checkMapExpected()&&(this._answers.push(this.mapExpected.concat()),o++)},h=()=>(this.lookUpAll(e,s,n),1==o);if(this.renge>1){const[i,s]=[t-this.renge+1,t+this.renge-1];let[a,r]=[0,0];for(;i+a<1;)a++;for(;s-r>e;)r++;if(a>this.renge)return h();if(r>this.renge)return h();const l=i+a,c=t-r;if(c-l<0)return h();let m=l;m+=Math.floor(Math.random()*(c-l));for(let t=m;t<m+this.renge;t++)if(this.lookUpAll(e,t,n),t==this.numberMimics){if(1!=o)return!1}else if(1==o)return!1;return this.mimicRenge=[m,m+this.renge-1],alert(m+"匹から"+(m+this.renge-1)+"匹ミミックが居るよ"),!0}return h()}lookUpAll(e,t,i){if(e<=0&&t<=0&&e<=t)return;const s=Array(t).fill(0);s.forEach(((e,t)=>s[t]=t));let a=s[t-1];for(;;){if(!(a<e)){let i=t-1;for(;i>=0&&s[--i]>=e-t+i;);if(i>=0){let e=++s[i];for(let a=++i;a<t;a++)s[a]=++e;a=s[t-1];continue}break}s[t-1]=a,i(s),a++}}experiment(e,t,i){this.setArray(this.mapExpected,e),i.forEach((e=>this.mapExpected[Math.floor(e/this.formY)][e%this.formY]=t))}get answers(){return this._answers}checkMapExpected(){for(const e of this.enemies)for(const t of e)if(!this.checkGmk(t))return!1;return!0}checkMap(e,t,i){let s;const a=/ミミックだよ|いるよ/.test(i);"treasure"==t?s=a?"mimic":"treasure":"mimic"==t&&(s=a?"treasure":"mimic");for(const t of e)if("mimic"==this.mapExpected[t[0]][t[1]])return"mimic"==s;return"mimic"!=s}getNextTo(){const e=[];for(let t=0;t<this.formX;t++)for(let i=0;i<this.formY;i++)if("mimic"==this.mapExpected[t][i])for(let s=1;s>-2;s-=2)this.inRoom(t+s,i)&&e.push([t+s,i]),this.inRoom(t,i+s)&&e.push([t,i+s]);return e.filter(((e,t,i)=>t===i.indexOf(e)))}checkGmk(e){const t=e.place,i=e.pattern,s=this.mapExpected[t[0]][t[1]];if(null==i)return!1;switch(i){case"sleeper":case"pair":return!0;case"nextTo":return this.checkMap(this.getNextTo(),s,e.serif);default:return this.checkMap(e.position,s,e.serif)}}inRoom(e,t){return 0<=e&&e<this.formX&&0<=t&&t<this.formY}}class a{constructor(e,t){this.enemies=[],this.formX=e[0],this.formY=e[1],this.numberEnemies=t}setEnemies(){for(let e=0;e<this.formX;e++){const i=[];for(let s=0;s<this.formY;s++){const a=new t(e*this.formY+s,1,20,"treasure",e,s);i.push(a)}this.addEnemy(i.concat())}let e=[];for(let t=0;t<this.formX;t++)for(let i=0;i<this.formY;i++)"treasure"==this.enemies[t][i].state&&e.push([t,i]);let i=this.numberEnemies;for(;i>0&&e.length>0;){const t=Math.floor(Math.random()*e.length);this.enemies[e[t][0]][e[t][1]].state="mimic",i--,e.splice(t,1)}}addEnemy(e){this.enemies.push(e)}}const r=class{constructor(e){this.depth=e,this.field,this.shape,this.numberMimics}nextReady(){let e,t,i;if(this.depth++,this.field=void 0,this.shape=void 0,this.depth<10)return e="easy",this.numberMimics=1+Math.floor(2*Math.random()),t=2+Math.floor(2*Math.random()),i=2+Math.floor(2*Math.random()),[[t,i],this.numberMimics,"easy"]}setRoom(e,t,r){(e.length<1||e[0].length<1)&&alert("不正な引数です"),this.shape=e.concat(),this.numberMimics=t;let o=0;do{if(o++,this.field=new a(e.concat(),t),this.field.setEnemies(),this.gimmicks=new i(this.field.enemies,e.concat(),t),this.gimmicks.setDifficulty(r),this.checker=new s(this.field.enemies,t),20==o){alert("この問題は複数答えが存在します");break}}while(!this.checker.checkReality());return this.checker.answers}getBoxState(e,t){return this.field.enemies[e][t].state}displayText(){const e=new RPG.UIElement;e.autoWidth=!0,e.autoHeight=!0,e.textMargin=[1,1,1,1],e.fontSize=3;let t="階層 : "+this.depth+"\nmimics : "+this.numberMimics;for(let i=0;i<this.shape[1];i++){t+="\n";for(let s=0;s<this.shape[0];s++){t=`${t}[${s*this.shape[1]+i}]`;let a=md.getMapPlaceFromRoomPlace(s,i);const r=[a[0]+.5,a[1]-.3],o=e.clone();o.text=this.field.enemies[s][i].condition[3],o.horizontalAlign="center",o.positionType="map",o.x=r[0],o.y=r[1],md.renderer.elements.push(o)}}t+="\n";for(let e=0;e<this.shape[0];e++)for(let i=0;i<this.shape[1];i++)t=`${t} \n[${this.field.enemies[e][i].condition[0]}] ${this.field.enemies[e][i].condition[2]} {${this.field.enemies[e][i].condition[3]})`;t+="\n";for(let e=0;e<this.shape[1];e++){t+="\n";for(let i=0;i<this.shape[0];i++)t=`${t}[${this.field.enemies[i][e].condition[1]}]`}}getSerifAt(e,t){return this.field.enemies[e][t].condition[3]}};class o{static timescale=1;id=0;time=0;initialize(){}update(e){}completed(){}repeatMode="restart";constructor(){}start(e){let t=(e=e||{}).time||this.time;t*=o.timescale,this.initialize();let i=this.id;return new Promise((s=>{const a=this,r=e.times?e.times:1;let o=0,n="flap"==this.repeatMode,h=performance.now(),l=!1;!function e(c){if(i!=a.id)return s(),void a.completed();if(c-h>=t&&(a.update(l?0:1),++o==r))return s(),void a.completed();l=n&&o%2==1;let m=Math.max((c-h)/t,0);a.update(l?1-m:m),requestAnimationFrame(e)}(h)}))}stop(){this.id++}static async direct(e,t,i){let s=new o;s.update=e,s.time=t,await s.start(i)}}const n={Game:class{map=null;controlEnabled=!0;player={x:0,y:0};playerAngle="front";playerAnimationRate=.7;playerWalked=0;playerAnimationState=0;playerCollisionOffset=.3;playerPieces=[];animationPieces=[];camera={x:0,y:0};#e=0;uitarget=null;constructor(){}createPlayerPiecesFromURL(e,t,i){for(let s=0;s<2;s++)for(let a=0;a<4;a++){const r=new n.Piece;r.image=new n.Image({url:e,x:a*t,y:s*i,width:t,height:i}),this.playerPieces.push(r)}}getImagePlaceFromAngle(e){switch(e){case"front":return 0;case"back":return 2;case"left":return 4;case"right":return 6}}playerWalk(e,t){if(this.controlEnabled){let i=Math.round(this.player.x),s=Math.round(this.player.y),a=this.playerAngle;0==e&&0==t||(Math.abs(e)>Math.abs(t)?this.playerAngle=e>0?"right":"left":this.playerAngle=t>0?"front":"back");for(let i=0;i<2;i++)for(let s=0;s<2;s++){let a=this.playerCollisionOffset*(-2*s+1),r=this.playerCollisionOffset*(-2*i+1);this.canPlayerWalk(this.player.x+s+e+a,this.player.y+i+r)||(e=0),this.canPlayerWalk(this.player.x+s+a,this.player.y+i+t+r)||(t=0)}this.player.x+=e,this.player.y+=t,0==e&&0==t||(this.playerWalked+=Math.sqrt(e**2+t**2),this.playerWalked>this.playerAnimationRate&&(this.playerWalked%=this.playerAnimationRate,this.playerAnimationState^=1));let r=Math.round(this.player.x),o=Math.round(this.player.y),n=r!=i||o!=s;if(n)for(let e=0;e<this.map.layers;e++){let t=this.map.at(e,r,o);if(null!=t&&(t.onstep(),!this.map))return}(n||this.playerAngle!=a)&&this.recalc()}}recalc(){if(!this.map)return;let e=Math.round(this.player.x),t=Math.round(this.player.y);this.lastLooking&&(this.lastLooking.children=[]);for(let i=0;i<this.map.layers;i++){let s=this.getPlayerDirection(),a=this.map.at(i,e+s[0],t+s[1]);null!=a&&(a.ontouch(a,e+s[0],t+s[1],this.map),""!=a.message&&(a.messageElem.x=e+s[0],a.messageElem.y=t+s[1],a.children=[a.messageElem],this.lastLooking=a))}this.animationPieces.forEach((e=>{e.image=e.images[e.animationIndex]}))}canPlayerWalk(e,t){for(let i=0;i<this.map.layers;i++){if(null==this.map.at(i,e,t))continue;if("wall"==this.map.at(i,e,t).type)return!1}return this.canPlayerWalkExtra(e,t)}canPlayerWalkExtra(e,t){return!0}getPlayerDirection(){switch(this.playerAngle){case"front":return[0,1];case"back":return[0,-1];case"left":return[-1,0];case"right":return[1,0]}}action(){if(this.map)for(let e=0;e<this.map.layers;e++){let t=this.getPlayerDirection(),i=Math.round(this.player.x+t[0]),s=Math.round(this.player.y+t[1]),a=this.map.at(e,i,s);null!=a&&a.action(a,e,i,s,this.map)}null!=this.uitarget&&this.uitarget.action()}up(){null!=this.uitarget&&this.uitarget.up()}down(){null!=this.uitarget&&this.uitarget.down()}},Renderer:class{game=null;canvas=null;ctx=null;imageData=null;buf=null;scale=1;elements=[];noticeAction=null;constructor(e,t){this.game=e,this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.imageData=this.ctx.createImageData(this.canvas.width,this.canvas.height),this.buf=this.imageData.data,this.ctx.textBaseline="top"}async initialize(){await this.loadFont()}draw(){this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.elements.forEach((e=>{e.render(this),this.renderLoop(e)}))}renderLoop(e){e.children.forEach((t=>{let i=t.opacity;t.opacity*=e.opacity,t.render(this),t.opacity=i,this.renderLoop(t)}))}drawPiece(e,t,i){this.game.map,this.canvas.width,this.canvas.height;let s=this.getCanvasPlaceFromMapPlace(t,i),a=s.x,r=s.y;null!=e&&null!=e.image.data&&this.ctx.drawImage(e.image.data,a,r,this.scale,this.scale)}getMapPlaceFromCanvasPlace(e,t){return{x:(e-this.canvas.width/2)/this.scale+this.game.camera.x+.5,y:(t-this.canvas.height/2)/this.scale+this.game.camera.y+.5}}getCanvasPlaceFromMapPlace(e,t){return{x:this.scale*(e-this.game.camera.x-.5)+this.canvas.width/2,y:this.scale*(t-this.game.camera.y-.5)+this.canvas.height/2}}async loadFont(){const e=await fetch("https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap");if(e.ok){const t=(await e.text()).match(/url\(.+?\)/g);if(!t)return;for(const e of t){const t=new FontFace("GameFont",e);document.fonts.add(t),await t.load()}}}action(){null!=this.noticeAction?(this.noticeAction(),this.noticeAction=null):this.game.action()}waitForAction(){return new Promise((e=>{this.noticeAction=e}))}messageBox(e,t,i){i||(i={});let s=new n.UIElement;s.autoWidth=!0,s.autoHeight=!0,s.horizontalAlign="center",s.backColor="#000000cc",s.x=this.canvas.width/2,s.y=this.canvas.height/2,s.fontSize=42,s.textMargin=[24,36,24,36],s.radius=18,s.border=2,s.text=e,s.text+="\n\n＊ "+t,this.elements.push(s);let a,r=!0;return null!=i.modal&&(r=!!i.modal),r&&(this.game.controlEnabled=!1),null!=i.fade&&(a=new o,a.reverse=!1,a.update=e=>{s.opacity=a.reverse?1-e:e}),new Promise((e=>{a&&a.start({time:500}),this.waitForAction().then((()=>{this.elements.splice(this.elements.indexOf(s),1),r&&(this.game.controlEnabled=!0),e()}))}))}},Image:class{data=null;width=0;height=0;constructor(e){if(null!=e.data&&(this.data=e.data,null!=e.width?(this.width=e.width,this.height=e.height):(this.width=this.data.width,this.height=this.data.height)),e.url){let t=e.width,i=e.height;this.width=t,this.height=i;let s=null!=e.x?[e.x,e.y,t,i]:[];this.getDataFromURL(e.url,...s).then((e=>{this.data=e}))}}getDataFromURL(...e){if(1!=e.length&&5!=e.length)return;let t=document.createElement("img");t.dx=5==e.length?e[1]:0,t.dy=5==e.length?e[2]:0,t.pieceWidth=5==e.length?e[3]:-1,t.pieceHeight=5==e.length?e[4]:-1;let i=new XMLHttpRequest;return i.open("GET",e[0],!0),i.responseType="arraybuffer",i.img=t,i.send(),new Promise((e=>{i.onload=function(t){let i=new Blob([this.response]),s=URL.createObjectURL(i);this.img.src=s,this.img.onload=function(){let t=-1!=this.pieceWidth?this.pieceWidth:this.naturalWidth,i=-1!=this.pieceHeight?this.pieceHeight:this.naturalHeight;const s=document.createElement("canvas");s.width=t,s.height=i;const a=s.getContext("2d"),r=a.getImageData(0,0,t,i);r.data.fill(0),a.putImageData(r,0,0),a.drawImage(this,-this.dx,-this.dy,this.naturalWidth,this.naturalHeight);const o=a.getImageData(0,0,t,i);new Uint8ClampedArray(o.data.buffer);createImageBitmap(o).then((t=>{e(t)}))}}}))}},Element:class{children=[];opacity=1;zLayer="default";constructor(e){Object.assign(this,e)}render(e){}up(){}down(){}},ElementList:class{array=[];constructor(){}add(e){this.array.push(e)}remove(e){this.array.splice(this.array.indexOf(e),1)}clear(){this.array=[]}setZIndex(e){}}};n.Map=class extends n.Element{layers=0;width=0;height=0;pieces=[];data=[];outside=null;constructor(e,t,i){super(),this.layers=e,this.width=t,this.height=i;for(let s=0;s<e;s++){let e=new Array(t).fill(null),s=[];for(let t=0;t<i;t++)s.push(e.concat());this.data.push(s)}}render(e){let t=e.game,i=t.map;t.recalc();let s=e.canvas.width,a=e.canvas.height;e.ctx.globalAlpha=this.opacity,e.buf.fill(0),e.ctx.fillStyle="#000000",e.ctx.fillRect(0,0,s,a);let r=e.getMapPlaceFromCanvasPlace(0,0),o=Math.floor(r.x),h=Math.floor(r.y),l=e.getCanvasPlaceFromMapPlace(o,h),c=new n.UIElement;for(let t=0;t<=Math.ceil(a/e.scale);t++)for(let a=0;a<=Math.ceil(s/e.scale);a++)for(let s=0;s<i.layers;s++){const r=i.at(s,o+a,h+t);null!=r&&(-1==c.children.indexOf(r)&&c.children.push(...r.children),null!=r.image.data&&e.ctx.drawImage(r.image.data,l.x+a*e.scale,l.y+t*e.scale,e.scale,e.scale))}const m=t.playerPieces[t.getImagePlaceFromAngle(t.playerAngle)+t.playerAnimationState];let d=e.getCanvasPlaceFromMapPlace(t.player.x,t.player.y);e.ctx.drawImage(m.image.data,d.x,d.y,e.scale,e.scale),this.children=[c],e.ctx.globalAlpha=1}inside(e,t){return 0<=e&&e<this.width&&0<=t&&t<this.height}at(e,t,i){if(this.inside(t,i)){return this.data[e][Math.floor(i)][Math.floor(t)]}return 0==e?this.outside:null}},n.Piece=class extends n.Element{width=0;height=0;image=null;images=null;animation=null;animationIndex=0;lastTime=0;type="floor";messageText="";messageElem=null;onstep=function(){};ontouch=function(e,t,i,s){};action=function(e,t,i,s){};constructor(){super()}get message(){return this.messageText}set message(e){this.messageText=e;let t=new n.UIElement;t.positionType="map",t.textMargin=[.5,1,.5,1],t.fontSize=2.5,t.textColor="#111111",t.backColor="#ffffffcc",t.borderColor="#111111",t.autoWidth=!0,t.autoHeight=!0,t.horizontalAlign="center",t.text=e,this.messageElem=t}clone(){let e=new n.Piece;return e=Object.assign(e,this),e.message=this.message,e.image=this.image,e}beginAnimation(){let e=()=>{this.animationIndex=(this.animationIndex+1)%this.animation.length,this.image=this.images[this.animation[this.animationIndex][0]],setTimeout(e,this.animation[this.animationIndex][1])};e()}},n.UIElement=class extends n.Element{positionType="canvas";x=0;y=0;enabled=!0;width=0;height=0;autoWidth=!1;autoHeight=!1;horizontalRatio=.5;verticalRatio=.5;horizontalTextRatio=0;verticalTextRatio=.5;backColor="#000000aa";textColor="#dddddd";border=.2;borderColor="#dddddd";radius=1;shadowBlur=0;shadowColor="#00000000";text="";font="GameFont";fontSize=4;textMargin=[4,2,4,2];opacity=1;image=null;constructor(e){super(e),Object.assign(this,e)}render(e){if(e.ctx.restore(),!this.enabled)return;e.ctx.globalAlpha=this.opacity;let t="canvas"==this.positionType?1:e.scale/10;e.ctx.font=this.fontSize*t+"px "+this.font;let i=this.text.split("\n"),s=0;for(const t of i){const i=e.ctx.measureText(t);s=i.width>s?i.width:s}const a=e.ctx.measureText(this.text);let r=this.width,o=this.height;this.autoWidth&&(r=(s+(this.textMargin[1]+this.textMargin[3])*t)/t),this.autoHeight&&(o=(a.fontBoundingBoxDescent*i.length+(this.textMargin[0]+this.textMargin[2])*t)/t);let n=null;"canvas"==this.positionType?n={x:this.x,y:this.y}:(n=e.getCanvasPlaceFromMapPlace(this.x+.5,this.y+.5),r*=t,o*=t);const h=n.x-this.horizontalRatio*r,l=n.y-this.verticalRatio*o;e.ctx.fillStyle=this.backColor,e.ctx.strokeStyle=this.borderColor,e.ctx.lineWidth=this.border*t,e.ctx.shadowColor=this.shadowColor,e.ctx.shadowBlur=this.shadowBlur,e.ctx.beginPath(),e.ctx.roundRect(h,l,r,o,this.radius*t),e.ctx.closePath(),e.ctx.fill(),e.ctx.stroke(),e.ctx.fillStyle=this.textColor;for(let s=0;s<i.length;s++)e.ctx.fillText(i[s],h+this.textMargin[3]*t,l+this.textMargin[0]*t+a.fontBoundingBoxDescent*s);this.image&&this.image.data&&e.ctx.drawImage(this.image.data,h,l,r,o),e.ctx.globalAlpha=1}get horizontalAlign(){switch(this.horizontalRatio){case 0:return"left";case.5:return"center";case 1:return"right"}}set horizontalAlign(e){switch(e){case"left":this.horizontalRatio=0;break;case"center":this.horizontalRatio=.5;break;case"right":this.horizontalRatio=1}}get verticalAlign(){switch(this.verticalRatio){case 0:return"top";case.5:return"center";case 1:return"bottom"}}set verticalAlign(e){switch(e){case"top":this.verticalRatio=0;break;case"center":this.verticalRatio=.5;break;case"bottom":this.verticalRatio=1}}clone(){let e=new n.UIElement;return Object.assign(e,this),e}},n.SelectElement=class extends n.UIElement{constructor(e){super(),this.lines=[],this.value=0,this.onaction=()=>{};let t=new n.UIElement({autoWidth:!0,autoHeight:!0,horizontalAlign:"center",backColor:"#000000cc",fontSize:4,textMargin:[4,8,4,8],radius:2,border:.2});Object.assign(this,t),this.positionType="map"}get textList(){return this.lines}set textList(e){this.lines=e,this.setText()}setText(){this.text="",this.textList.forEach(((e,t)=>{this.textList&&(this.text+=(t==this.value?"＊ ":"   ")+e+(t==this.textList.length-1?"":"\n"))}))}up(){this.canChangeTo(this.value-1)&&this.value--,this.setText()}down(){this.canChangeTo(this.value+1)&&this.value++,this.setText()}action(){this.onaction(this.value)}canChangeTo(e){return e>=0&&e<this.textList.length}};const h=n,l=1920,c=1080;o.timescale=1;let m=new class{constructor(e){this.canvas=null,this.game=null,this.renderer=null,this.map=null,this.pieces={},this.playerWalkSpeed=5,this.previousTimeStamp=-1,this.treasureLayer=1,this.dungeons=[],this.rooms=[],this.level=0,this.charInputAllowed=!1,this.game=new h.Game,this.canvas=e,e.width=l,e.height=c,this.canvasScale=null,this.renderer=new h.Renderer(this.game,e),this.renderer.scale=128,this.messages=null,this.controller={x:0,y:0},this.initialize()}async initialize(){this.renderer.ctx.fillStyle="white",this.renderer.ctx.font="50px sans-serif",this.renderer.ctx.fillText("LOADING...",0,0),this.attachResizeEvent(),await this.renderer.initialize(),this.initializePieces(),this.initializeMessages(),this.createUiTitle(),this.createUiEnding(),this.game.canPlayerWalkExtra=(e,t)=>!this.isRoomClosed||null!=this.getRoomAt(e,t),this.toUiTitle(),this.loop(1)}attachResizeEvent(){const e=()=>{const e=l/c,t=window.innerWidth/window.innerHeight,i=e>t?window.innerWidth/canvas.width:window.innerHeight/canvas.height;canvas.style.width=l*i+"px",canvas.style.height=c*i+"px",e>t?canvas.style.top=(window.innerHeight-canvas.height*i)/2+"px":canvas.style.left=(window.innerWidth-canvas.width*i)/2+"px",this.canvasScale=i};addEventListener("resize",e),e()}initializePieces(){const e="resources/pieces/pieces.png";this.pieces.wall=new h.Piece,this.pieces.wall.image=new h.Image({url:e,x:32,y:32,width:32,height:32}),this.pieces.wall.type="floor",this.pieces.rock=new h.Piece,this.pieces.rock.image=new h.Image({url:e,x:32,y:64,width:32,height:32}),this.pieces.rock.type="wall",this.pieces.floor=new h.Piece,this.pieces.floor.image=new h.Image({url:e,x:0,y:32,width:32,height:32}),this.pieces.floor.type="floor",this.pieces.sand=new h.Piece,this.pieces.sand.image=new h.Image({url:e,x:32,y:32,width:32,height:32}),this.pieces.sand.type="floor",this.pieces.doro=new h.Piece,this.pieces.doro.image=new h.Image({url:e,x:32,y:96,width:32,height:32}),this.pieces.doro.type="floor",this.pieces.arrow=new h.Piece,this.pieces.arrow.image=new h.Image({url:"resources/arrows/up arrow.png"}),this.pieces.stair=new h.Piece,this.pieces.stair.image=new h.Image({url:"resources/grades/grade.png"});let t=this;this.pieces.stair.onstep=()=>{t.stairOnStep(t)};const i=new h.Piece;i.type="wall",i.images=Array(2).fill(null),i.images.forEach(((t,i,s)=>{const a=new h.Image({url:e,x:64+32*i,y:32,width:32,height:32});s[i]=a})),i.animation=[[0,400],[1,400]],i.beginAnimation(),this.pieces.sea=i;const s=new h.Piece(32,32);s.type="wall",s.images=Array(2).fill(null),s.images.forEach(((t,i,s)=>{const a=new h.Image({url:e,x:64+32*i,y:96,width:32,height:32});s[i]=a})),s.animation=[[0,400],[1,400]],s.beginAnimation(),this.pieces.yougan=s;const a=new h.Piece(32,32);a.type="floor",a.images=Array(2).fill(null),a.images.forEach(((t,i,s)=>{const a=new h.Image({url:e,x:64+32*i,y:64,width:32,height:32});s[i]=a})),a.animation=[[0,400],[1,400]],a.beginAnimation(),this.pieces.doku=a,this.game.createPlayerPiecesFromURL("resources/pieces/character.png",16,16);const r=[];for(let e=0;e<16;e++){const t={0:"resources/treasure boxes/red treasure 1.png",1:"resources/treasure boxes/red treasure 2.png",2:"resources/treasure boxes/red treasure 3.png",3:"resources/treasure boxes/red treasure 4.png",4:"resources/treasure boxes/green treasure 1.png",5:"resources/treasure boxes/green treasure 2.png",6:"resources/treasure boxes/green treasure 3.png",7:"resources/treasure boxes/green treasure 4.png",8:"resources/treasure boxes/blue treasure 1.png",9:"resources/treasure boxes/blue treasure 2.png",10:"resources/treasure boxes/blue treasure 3.png",11:"resources/treasure boxes/blue treasure 4.png",12:"resources/treasure boxes/black treasure 1.png",13:"resources/treasure boxes/black treasure 2.png",14:"resources/treasure boxes/black treasure 3.png",15:"resources/treasure boxes/black treasure 4.png"},i=new h.Piece;i.image=new h.Image({url:t[e]}),i.message="＊ ミミックにマーク",i.action=e%4==0?(e,t,i,s)=>{this.map.data[this.treasureLayer][s+1][i]!=this.pieces.arrow?(this.map.data[this.treasureLayer][s+1][i]=this.pieces.arrow,e.message="＊ 宝箱にマーク"):(this.map.data[this.treasureLayer][s+1][i]=null,e.message="＊ ミミックにマーク")}:(e,t,i)=>{this.map.data[this.treasureLayer][i+1][t]=null},i.type="wall",i.id=e,r.push(i)}this.pieces.boxes=r;const o=new h.Piece;o.type="wall",o.images=Array(7).fill(null),o.images.forEach(((e,t,i)=>{i[t]=new h.Image({url:"resources/pieces/key.png",x:32*t,y:0,width:32,height:32})})),this.pieces.key=o,o.animation=[[0,3e3],[1,80],[2,80],[3,80],[4,80],[5,80],[6,80]],o.message="＊ 宝箱を開ける"}async initializeMessages(){let e=await fetch("messages.json");if(!e.ok)throw new Error("messages.jsonを読み込めませんでした");this.messages=await e.json()}createUiTitle(){const e=new h.UIElement;this.uiTitle=e;const t=new h.UIElement({positionType:"canvas",horizontalAlign:"left",verticalAlign:"top",width:l,height:c});this.titleGradient=this.renderer.ctx.createLinearGradient(0,0,0,c),this.titleGradient.addColorStop(0,"#000080"),this.titleGradient.addColorStop(1,"#000000"),t.backColor=this.titleGradient,this.uiTitleBack=t;const i=new h.UIElement({positionType:"map",x:8,y:4,width:81,height:48,backColor:"#00000000",borderColor:"#00000000",image:new h.Image({url:"resources/logos/title_logo.png"})}),s=new o;s.update=e=>{i.y=4.5+.2*Math.sin(2*e*Math.PI)},s.start({time:4800,times:1/0});const a=new h.SelectElement(this.renderer);a.textList=["冒険を始める"],a.x=8,a.y=8.5,e.children.push(t,i,a),a.onaction=async t=>(this.game.uitarget=null,await o.direct((t=>{e.opacity=1-t}),1200),void(await this.askHowToPlay()?this.toHowToPlay():(this.createUiDungeon(),this.toUiDungeon())));const r=new h.UIElement({positionType:"canvas",x:1910,y:1070,autoWidth:!0,autoHeight:!0,horizontalAlign:"right",verticalAlign:"bottom",backColor:"#00000000",borderColor:"#00000000",fontSize:30,text:"v1.1.4"});e.children.push(r),this.uiTitle=e,this.uiTitleStart=a}async toUiTitle(){this.level=0,this.game.camera={x:8,y:6},this.renderer.elements=[this.uiTitle],await o.direct((e=>this.uiTitle.opacity=e),500),this.game.uitarget=this.uiTitleStart}async askHowToPlay(){let e=new h.UIElement({x:960,y:300,autoWidth:!0,autoHeight:!0,backColor:"#00000000",borderColor:"#00000000",fontSize:50,text:"遊び方を見ますか？"});const t=new h.SelectElement(this.renderer);return t.textList=["はい","いいえ"],t.x=8,t.y=8,this.renderer.elements=[e,t],this.game.uitarget=t,new Promise((e=>{t.onaction=t=>{this.game.uitarget=null,this.renderer.elements=[],e(0==t)}}))}async toHowToPlay(){let e=new h.UIElement({positionType:"map",x:1,y:2,horizontalAlign:"left",verticalAlign:"top",autoWidth:!0,autoHeight:!0,backColor:"#00000000",borderColor:"#00000000",fontSize:5});this.uiTextBlock=e;let t=new h.UIElement({backColor:"#00000000",borderColor:"#00000000",opacity:0});const i=new h.UIElement({image:this.pieces.boxes[0].image,width:128,height:128,x:560,y:800,borderColor:"#00000000"}),s=new h.UIElement({image:this.pieces.boxes[4].image,width:128,height:128,x:960,y:800,borderColor:"#00000000"}),a=new h.UIElement({image:this.pieces.boxes[8].image,width:128,height:128,x:1360,y:800,borderColor:"#00000000"});t.children.push(i,s,a);let r=new h.UIElement({backColor:"#00000000",borderColor:"#00000000",opacity:0});const n=new h.UIElement({autoWidth:!0,autoHeight:!0,x:560,y:650,borderColor:"#00000000",fontSize:40,text:"真の宝箱"}),l=new h.UIElement({autoWidth:!0,autoHeight:!0,x:960,y:650,borderColor:"#00000000",fontSize:40,text:"ミミック"}),c=new h.UIElement({autoWidth:!0,autoHeight:!0,x:1360,y:650,borderColor:"#00000000",fontSize:40,text:"真の宝箱"});r.children.push(n,l,c),this.renderer.elements=[e,t,r];let m=this.messages.intro;await this.showParagraph(m[0]),await this.renderer.waitForAction(),await this.hideParagraph(),await Promise.all([o.direct((e=>t.opacity=e),500),this.showParagraph(m[1])]),await this.renderer.waitForAction(),await this.hideParagraph(),i.image=this.pieces.boxes[1].image,s.image=this.pieces.boxes[6].image,a.image=this.pieces.boxes[9].image,await Promise.all([o.direct((e=>r.opacity=e),500),this.showParagraph(m[2])]),await this.renderer.waitForAction(),await this.hideParagraph(),i.image=this.pieces.boxes[0].image,s.image=this.pieces.boxes[4].image,a.image=this.pieces.boxes[8].image,await Promise.all([o.direct((e=>r.opacity=1-e),500),this.showParagraph(m[3])]),await this.renderer.waitForAction(),await this.hideParagraph(),n.text="右の宝箱は\nミミックだ",l.text="左の宝箱は\nミミックだ",c.text="一番左の宝箱は\nミミックじゃない",await Promise.all([o.direct((e=>r.opacity=e),500),this.showParagraph(m[4])]),await this.renderer.waitForAction(),await this.hideParagraph(),i.image=this.pieces.boxes[1].image,s.image=this.pieces.boxes[6].image,a.image=this.pieces.boxes[9].image,await Promise.all([o.direct((e=>r.opacity=1-e),500),this.showParagraph(m[5])]),await this.renderer.waitForAction(),await Promise.all([o.direct((e=>t.opacity=1-e),500),this.hideParagraph()]),this.createUiDungeon(),this.toUiDungeon()}async showParagraph(e){this.uiTextBlock.opacity=1,this.uiTextBlock.y=2;let t="";for(const i of e)await o.direct((e=>{this.uiTextBlock.text=t+i.substr(0,Math.round(i.length*e))}),500),t+=i+"\n"}async hideParagraph(){await o.direct((e=>{this.uiTextBlock.opacity=1-e,this.uiTextBlock.y=2-e*e*1}),500)}createUiDungeon(){const e=[],t=[],i=[[2,2],[2,2],[3,2]];let s;switch(this.level%4){case 0:s="easy";break;case 1:i.splice(1,1,[3,2]),i.splice(2,1,[4,2]),s="hard";break;case 2:i.splice(0,1,[3,2]),i.splice(1,1,[4,2]),i.splice(2,1,[5,2]),s="expart";break;default:i.forEach(((e,t)=>i.splice(t,1,[this.level,this.level]))),s="expart"}for(let t=0;t<1;t++){const a=new r(0);a.setRoom(i[t],this.level+1,s),e.push(a)}const a=new h.UIElement,o=this.pieces;let n,l,c;switch(this.level%4){case 0:n=o.wall,l=o.floor,c=o.sea;break;case 1:n=o.sand,l=o.doro,c=o.sea;break;case 2:n=o.rock,l=o.sand,c=o.doku;break;case 3:n=o.rock,l=o.doro,c=o.yougan}const m=[],d=[],[u,g]=[4,3],[p,f]=[3,4];let y=0;e.forEach((e=>{y=Math.max(y,(e.shape[0]-1)*u+1+2*p)}));let w=f,x=0;e.toReversed().forEach(((i,s)=>{const r=s,[o,b]=[3,3],k=(i.shape[0]-1)*u+1+2*p,E=(i.shape[1]-1)*g+1+2*f,C=Math.round((y-k)/2);let v=p+C;w+=x,x=E+3,t.push({x:C,y:w-4,width:k,height:E});const M=[],A=[],I=Array(k).fill(n);I.forEach(((e,t,i)=>{Math.abs(k/2-.5-t)<1&&(i[t]=l)})),M.push(0==r?Array(k).fill(n):I.concat());for(let e=0;e<E-2;e++){const e=Array(k).fill(l);e[0]=n,e[e.length-1]=n,M.push(e)}if(M.push(r==e.length-1?Array(k).fill(n):I.concat()),r!=e.length-1){const e=Array(k).fill(c);e.forEach(((e,t,i)=>{const s=Math.floor(k/2-o/2)-1,a=s+o+1;s<t&&t<a&&(i[t]=l),t!=s&&t!=a||(i[t]=n)}));for(let t=0;t<b;t++)if(t==b-1){const t=e.concat();t.forEach(((e,t,i)=>{Math.abs(k/2-.5-t)<o/2+1&&(i[t]=this.pieces.rock)})),t[Math.round(t.length/2-1)]=l,M.push(t)}else M.push(e.concat())}M.forEach((e=>{e.unshift(...Array(C).fill(c)),e.push(...Array(C).fill(c))})),m.push(...M);for(let e=0;e<M.length;e++)A.push(Array(k).fill(null));for(let e=0;e<i.shape[1];e++)for(let t=0;t<i.shape[0];t++){let s;switch(i.field.enemies[t][e].color){case"red":s=0;break;case"green":s=1;break;case"blue":s=2;break;case"black":s=3}A[f+3*e][C+p+4*t]=this.pieces.boxes[4*s].clone();const r=new h.UIElement({positionType:"map",x:C+p+4*t,y:d.length+f+3*e-1,autoWidth:!0,autoHeight:!0,horizontalAlign:"center",verticalAlign:"center",textMargin:[1,1,1,1],fontSize:3,text:i.getSerifAt(t,e)});a.children.unshift(r)}d.push(...A);const S=this.pieces.key.clone();S.beginAnimation(),this.game.animationPieces.push(S),A[(0==r)+0][C+Math.floor(k/2)]=S;let P=w;S.action=(e,t,s,a,r)=>{this.keyAction(e,t,s,a,r,{dungeon:i,left:v,top:P,dx:u,dy:g})}})),this.map=new h.Map(4,m[0].length,m.length),this.map.data[0]=m,this.map.data[1]=d,this.map.outside=c,this.game.map=this.map,this.rooms=t.reverse(),a.children.unshift(this.map),this.dungeons=e,this.game.player={x:m[0].length/2-.5,y:m.length-2};const b=new h.UIElement({x:25,y:25,horizontalAlign:"left",verticalAlign:"top",width:300,height:60,radius:20,borderColor:"#white",backColor:"#000000aa",border:3}),k=new h.UIElement({x:50,y:55,horizontalAlign:"left",autoWidth:!0,autoHeight:!0,borderColor:"#00000000",backColor:"#00000000",fontSize:35,text:"LEVEL 1 - 1"});b.children.push(k);const E=new h.UIElement({x:25,y:100,horizontalAlign:"left",verticalAlign:"top",width:300,height:150,radius:20,borderColor:"#000000",backColor:"#d1c9be",border:4});E.children=[new h.UIElement({x:50,y:130,horizontalAlign:"left",autoWidth:!0,autoHeight:!0,borderColor:"#00000000",backColor:"#00000000",fontSize:30,textColor:"black",text:"宝箱の情報"}),new h.UIElement({x:50,y:175,horizontalAlign:"left",autoWidth:!0,autoHeight:!0,borderColor:"#00000000",backColor:"#00000000",fontSize:25,textColor:"#000000aa",text:"・真の宝箱:"}),new h.UIElement({x:50,y:220,horizontalAlign:"left",autoWidth:!0,autoHeight:!0,borderColor:"#00000000",backColor:"#00000000",fontSize:25,textColor:"#000000aa",text:"・ミミック:"})];const C=new h.UIElement({x:250,y:175,horizontalAlign:"right",autoWidth:!0,autoHeight:!0,borderColor:"#00000000",backColor:"#00000000",fontSize:30,textColor:"#000000",text:"未設定"}),v=new h.UIElement({x:250,y:220,horizontalAlign:"right",autoWidth:!0,autoHeight:!0,borderColor:"#00000000",backColor:"#00000000",fontSize:30,textColor:"#000000",text:"未設定"});E.children.push(C,v),a.children.push(b,E),this.uiDungeonLevelText=k,this.uiDungeonInfo=E,this.uiDungeonInfoMimics=v,this.uiDungeonInfoTreasures=C,this.uiDungeon=a}async toUiDungeon(){this.uiDungeonInfo.opacity=0,this.renderer.elements.push(this.uiDungeon);const e=new h.UIElement({height:360,backColor:"#00000088",borderColor:"#00000000",x:960,y:540}),t=new h.UIElement({autoWidth:!0,autoHeight:!0,backColor:"#00000000",borderColor:"#00000000",x:960,y:490,text:`LEVEL ${this.level+1}`,fontSize:100}),i=this.dungeons.reduce(((e,t)=>e+t.numberMimics),0),s=this.dungeons.reduce(((e,t)=>e+t.shape[0]*t.shape[1]),0)-i,a=new h.UIElement({autoWidth:!0,autoHeight:!0,backColor:"#00000000",borderColor:"#00000000",x:960,y:620,text:`真の宝箱の総数: ${s}\nミミックの総数: ${i}`,fontSize:40});this.renderer.elements=[this.uiDungeon];await Promise.all([(async()=>{await o.direct((e=>this.uiDungeon.opacity=e),500),this.renderer.elements.push(e,t,a),await o.direct((i=>{t.opacity=i,a.opacity=i,e.opacity=i,e.width=l*i}),800),await o.direct((()=>{}),2e3),await o.direct((i=>{t.opacity=1-i,a.opacity=1-i,e.opacity=1-i,e.width=l*(1-i)}),800)})(),(async()=>{const e=this.rooms[this.rooms.length-1],[t,i]=[e.x+e.width/2,e.y+e.height/2],s=this.renderer.scale;await o.direct((e=>{e=(1-Math.cos(e*Math.PI))/2,this.game.camera.x=t+(this.game.player.x-t)*e,this.game.camera.y=i+(this.game.player.y-i)*e,this.renderer.scale=s*(-.5*(1-e)+1)}),3e3)})()]),this.startDungeon(0)}async startDungeon(e){this.dungeonIndex=e;const t=this.dungeons[e];this.uiDungeonLevelText.text=`LEVEL ${this.level+1} - ${e+1}`,this.uiDungeonInfoMimics.text=t.numberMimics.toString(),this.uiDungeonInfoTreasures.text=(t.shape[0]*t.shape[1]-t.numberMimics).toString(),this.uiDungeonInfo.opacity=1;const i=[this.uiDungeonInfo,this.uiDungeonInfo.children].flat(),s=[];for(const e of i){const[t,i]=[e.x+960-150,e.y+540-100],[a,r]=[e.x,e.y];let n=o.direct((s=>{s=Math.max(3*s-2,0)**.7,e.x=t+(a-t)*s,e.y=i+(r-i)*s}),3e3);s.push(n)}const a=new o;a.update=e=>{e=e<.5?2*e:2*-e+2,this.uiDungeonInfo.borderColor=`rgb(${255*e},${255*e},0)`},s.push(a.start({time:750}));const r=this.uiDungeonInfo.height,n=this.uiDungeonInfo.y;s.push(o.direct((e=>{e**=.7,this.uiDungeonInfo.opacity=e,this.uiDungeonInfo.y=n+r*(1-e)/2,this.uiDungeonInfo.height=r*e}),500));const l=new h.UIElement({autoWidth:!0,autoHeight:!0,backColor:"#00000000",borderColor:"#00000000",x:960,y:390,text:`STAGE ${this.level+1} - ${this.dungeonIndex+1}`,fontSize:100,shadowColor:"black"});this.renderer.elements.push(l),s.push((async()=>{await o.direct((e=>{l.opacity=e,l.shadowBlur=30*e,l.textColor=`rgba(255,255,255,${e})`}),500),await o.direct((()=>{}),1e3),await o.direct((e=>{e=1-e,l.opacity=e,l.shadowBlur=30*e,l.textColor=`rgba(255,255,255,${e})`}),500)})());let m=this.game.player.x,d=this.game.player.y,u=this.getRoomCenter(),g=this.renderer.scale,p=Math.floor(c/this.getCurrentRoom().height);s.push(o.direct((e=>{this.game.camera={x:m+(u.x-m)*e,y:d+(u.y-d)*e},this.renderer.scale=g+(p-g)*e}),1e3)),this.isRoomClosed=!0,await Promise.all(s),this.charInputAllowed=!0}async keyAction(e,t,i,s,a,r){this.charInputAllowed=!1;const n=r.dungeon,l=r.left,c=r.top,m=r.dx,d=r.dy;let u=0;for(let e=0;e<n.shape[1];e++)for(let t=0;t<n.shape[0];t++)this.map.at(this.treasureLayer,l+t*m,c+e*d+1)==this.pieces.arrow&&u++;n.shape[0],n.shape[1],n.numberMimics;if(u!=n.numberMimics){let e=u-n.numberMimics,t=e>0?`${e}つ多すぎた！`:`まだ${-e}体隠れている！`;return await this.renderer.messageBox(`ミミックは ${n.numberMimics} 体だ。\n${t}`,"OK"),void(this.charInputAllowed=!0)}let g=!1;for(let e=0;e<n.shape[1];e++)for(let t=0;t<n.shape[0];t++){let i=l+t*m,s=c+e*d;const a=this.map.data[this.treasureLayer][s][i],r=this.map.at(this.treasureLayer,i,s+1)==this.pieces.arrow;if(a.message="",a.action=()=>{},r)continue;let u=this.game.camera.x,p=this.game.camera.y,f=this.renderer.scale;o.direct((e=>{e=(1-Math.cos(e*Math.PI))/2,this.game.camera.x=u+(i-u)*e,this.game.camera.y=p+(s-p)*e,this.renderer.scale=f+(128-f)*e}),500);const y="mimic"==n.getBoxState(t,e);if(a.image=this.pieces.boxes[a.id+1+y].image,this.game.playerWalk(0,-.1),this.game.player={x:i,y:s+1},await o.direct((e=>{}),800),!y)continue;g=!0;const w=new h.UIElement({positionType:"map",x:i,y:s,width:10,height:10,borderColor:"#00000000",backColor:"#00000000",image:this.pieces.boxes[a.id+3].image});return void this.gameOver(w)}this.controller={x:0,y:0},this.game.player={x:i,y:s+1},g?this.gameOver():(this.map.data[t][s][i]=null,this.stageClear().then((()=>{this.dungeonIndex!=this.dungeons.length-1&&this.startDungeon(++this.dungeonIndex)})))}async gameOver(e){this.charInputAllowed=!1;const t=new h.UIElement({positionType:"canvas",horizontalAlign:"left",verticalAlign:"top",width:l,height:c}),i=this.renderer.ctx.createLinearGradient(0,0,0,c);i.addColorStop(0,"#000000"),i.addColorStop(1,"#4f1d85"),t.backColor=i;const s=new h.UIElement({autoWidth:!0,autoHeight:!0,backColor:"#00000000",borderColor:"#00000000",x:960,y:290,text:"GAME OVER",fontSize:200}),a=new h.UIElement({autoWidth:!0,autoHeight:!0,backColor:"#00000000",borderColor:"#00000000",x:960,y:440,text:"宝箱は ミミックだった！",fontSize:50}),r=new h.SelectElement(this.renderer);r.textList=[`LEVEL ${this.level+1} からコンティニュー`,"タイトルに戻る"],r.x=8,r.y=8,r.enabled=!1,t.children.push(s,a,r,e),this.renderer.elements.push(t),await o.direct((e=>t.opacity=e),2e3),e.x+=8-this.game.camera.x,e.y+=6-this.game.camera.y,this.game.camera={x:8,y:6},this.renderer.scale=128,this.renderer.elements=[t],await o.direct((e=>{}),2e3),r.enabled=!0,this.game.uitarget=r,r.onaction=async e=>{this.game.uitarget=null,0==e?(this.createUiDungeon(),this.toUiDungeon()):this.toUiTitle()}}async stageClear(){this.charInputAllowed=!1,this.isRoomClosed=!1;let[e,t]=[this.game.camera.x,this.game.camera.y],i=this.renderer.scale;const s=[],a=new h.UIElement({autoWidth:!0,autoHeight:!0,backColor:"#00000000",borderColor:"#00000000",x:960,y:390,text:"STAGE CLEAR!",fontSize:100,shadowColor:"black"});this.renderer.elements.push(a),s.push((async()=>{await o.direct((e=>{a.opacity=e,a.shadowBlur=30*e,a.textColor=`rgba(255,255,255,${e})`}),500),await o.direct((()=>{}),1e3),await o.direct((e=>{e=1-e,a.opacity=e,a.shadowBlur=30*e,a.textColor=`rgba(255,255,255,${e})`}),500)})()),s.push(o.direct((s=>{this.game.camera.x=e+(this.game.player.x-e)*s,this.game.camera.y=t+(this.game.player.y-t)*s,this.renderer.scale=i+(128-i)*s}),500)),await Promise.all(s);const r=this.rooms[this.dungeonIndex+1],n=null==r;n&&(this.map.data[1][1][Math.floor(this.map.data[0][0].length/2)]=this.pieces.stair),await(async()=>{const e=()=>new Promise((e=>{setTimeout((()=>{this.game.playerWalk(0,.01*-this.playerWalkSpeed),this.game.camera=Object.assign({},this.game.player),e()}),10)}));if(n)for(let t=0;t<100/this.playerWalkSpeed;t++)await e();else{for(;this.getCurrentRoom()!=r;)await e();for(let t=0;t<50;t++)await e()}})()}async stairOnStep(){this.charInputAllowed=!1,await this.levelClear(),0==this.level?this.showEndingAndRestart():(this.level++,this.createUiDungeon(),this.toUiDungeon())}async levelClear(){const e=new h.UIElement({height:360,backColor:"#00000088",borderColor:"#00000000",x:960,y:540}),t=new h.UIElement({autoWidth:!0,autoHeight:!0,backColor:"#00000000",borderColor:"#00000000",x:960,y:540,text:`LEVEL ${this.level+1} CLEAR!`,fontSize:100});this.renderer.elements.push(e,t),await o.direct((i=>{t.opacity=i,e.opacity=i,e.width=l*i}),800),await o.direct((()=>{}),2e3),await o.direct((i=>{t.opacity=1-i,e.opacity=1-i,e.width=l*(1-i)}),800),this.renderer.elements=[this.uiDungeon],await o.direct((e=>this.uiDungeon.opacity=1-e),500)}createUiEnding(){const e=new h.UIElement;this.uiEnding=e;const t=new h.UIElement({positionType:"canvas",horizontalAlign:"left",verticalAlign:"top",width:l,height:c}),i=new h.UIElement({positionType:"canvas",horizontalAlign:"left",verticalAlign:"top",width:l,height:c});this.uiEndingNightGradient=this.renderer.ctx.createLinearGradient(0,0,0,c),this.uiEndingNightGradient.addColorStop(0,"#000080"),this.uiEndingNightGradient.addColorStop(1,"#000000"),i.backColor=this.uiEndingNightGradient;const s=new h.UIElement({positionType:"map",x:8,y:6,width:81,height:48,backColor:"#00000000",borderColor:"#00000000",image:new h.Image({url:"resources/logos/ending_logo.png"})}),a=new h.UIElement({positionType:"map",x:8,y:6,width:81,height:48,backColor:"#00000000",borderColor:"#00000000",image:new h.Image({url:"resources/logos/ending2_logo.png"})});this.uiEndingBack=t,this.uiEndingLogo=s,this.uiEnding2Logo=a,this.uiEndingBack2=i,e.children.push(t,s,a,i)}async showEndingAndRestart(){this.game.camera={x:8,y:6},this.renderer.elements=[this.uiEnding],Math.random()<.5?(this.uiEndingBack.backColor="#000000",this.uiEndingLogo.enabled=!0,this.uiEnding2Logo.enabled=!1):(this.uiEndingBack.backColor="#aaaaaa",this.uiEndingLogo.enabled=!1,this.uiEnding2Logo.enabled=!0),this.uiEndingBack2.opacity=1,this.uiEndingBack.opacity=0,this.uiEndingLogo.opacity=0,this.uiEnding2Logo.opacity=0,await o.direct((e=>this.uiEnding.opacity=e),1500),await o.direct((e=>{this.uiEndingBack.opacity=e,this.uiEndingBack2.opacity=1-e,this.uiEndingLogo.opacity=e,this.uiEnding2Logo.opacity=e}),1500),await o.direct((e=>{}),3e3),await o.direct((e=>this.uiEnding.opacity=1-e),500),await this.toUiTitle(),this.titleGradient=this.renderer.ctx.createLinearGradient(0,0,0,c),this.titleGradient.addColorStop(0,"#00c9ff"),this.titleGradient.addColorStop(.5,"#4facfe"),this.titleGradient.addColorStop(1,"#c3cfe2"),this.uiTitleBack.backColor=this.titleGradient;const e=100,t=new h.UIElement({positionType:"canvas",horizontalAlign:"left",verticalAlign:"top",width:l,height:1180});this.uiTitleBack.children=[t],await o.direct((i=>{const s=1180*(i=(1-Math.cos(i*Math.PI))/2)-100,a=this.renderer.ctx.createLinearGradient(0,s,0,s+c);a.addColorStop(0,"#00008000"),a.addColorStop(e/1180,"#000080"),a.addColorStop(1,"#000000"),t.backColor=a,t.y=s}),4e3),this.uiTitleBack.children=[]}setCamera(){this.isRoomClosed?this.game.camera=this.getRoomCenter():(this.game.camera.x=this.game.player.x,this.game.camera.y=this.game.player.y)}getRoomAt(e,t){return this.rooms.find((i=>i.x<=e&&e<i.x+i.width&&i.y<=t&&t<i.y+i.height))}getCurrentRoom(){let[e,t]=[this.game.player.x+.5,this.game.player.y+.5];return this.getRoomAt(e,t)}getRoomCenter(){const e=this.getCurrentRoom();return{x:e.x+e.width/2-.5,y:e.y+e.height/2-.5}}start(){this.toUiTitle()}loop(e){-1==this.previousTimeStamp&&(this.previousTimeStamp=e);const t=e-this.previousTimeStamp;if(this.previousTimeStamp=e,this.charInputAllowed){const e=this.playerWalkSpeed*t/1e3*this.controller.x,i=this.playerWalkSpeed*t/1e3*this.controller.y;this.game.player.x,this.game.player.y;this.game.playerWalk(e,i),this.charInputAllowed&&this.setCamera()}performance.now();this.renderer.draw();performance.now();requestAnimationFrame((e=>this.loop(e)))}onclick(e,t){this.renderer.action();const i=new h.UIElement({positionType:"canvas",borderColor:"#00000000",x:e,y:t});if(this.renderer.elements.push(i),o.direct((e=>{i.backColor=`rgba(200,200,200,${.5*(1-e)})`,i.width=50-25*e,i.height=50-25*e,i.radius=i.width/2}),500).then((()=>{let e=this.renderer.elements.indexOf(i);-1!=e&&this.renderer.elements.splice(e,1)})),!this.charInputAllowed)return;const s=Math.floor(this.renderer.getMapPlaceFromCanvasPlace(e,t).x),a=Math.floor(this.renderer.getMapPlaceFromCanvasPlace(e,t).y),r=this.map.data[this.treasureLayer][a][s];r?.action(r,this.treasureLayer,s,a,this.map);const n=new h.UIElement({positionType:"map",borderColor:"#00000000",x:s,y:a,width:10,height:10});this.renderer.elements.push(n),o.direct((e=>n.backColor=`rgba(255,255,255,${.5*(1-e)})`),500).then((()=>{let e=this.renderer.elements.indexOf(i);-1!=e&&this.renderer.elements.splice(e,1)}))}}(document.getElementById("canvas"));const d=document.getElementById("controller");function u(e,t){m.controller={x:e,y:t}}d.action=()=>m.renderer.action();const g=d.childNodes;"PC"==function(){const e=navigator.userAgent.toLowerCase();return e.includes("iphone")||e.includes("ipad")||e.indexOf("ipod")?"iOS":e.includes("android")?"Android":"PC"}()?(d.remove(),m.renderer.actionLabel="Space"):g.forEach((e=>{let t;switch(e.id){case"ctrl-action":t=()=>d.action();break;case"ctrl-top":t=()=>{u(0,-1),m.game.up()};break;case"ctrl-right":t=()=>u(1,0);break;case"ctrl-btm":t=()=>{u(0,1),m.game.down()};break;case"ctrl-left":t=()=>u(-1,0)}e.addEventListener("touchstart",t),e.addEventListener("touchend",(()=>u(0,0)))}));const p=[];function f(e){switch(e){case"KeyW":u(0,-1);break;case"KeyA":u(-1,0);break;case"KeyS":u(0,1);break;case"KeyD":u(1,0)}}document.addEventListener("keydown",(e=>{const t=m.charInputAllowed,i=p.includes(e.code);if("Space"!=e.code){if(i)return;t&&p.push(e.code)}t?f(e.code):function(e){switch(e){case"KeyW":m.game.up();break;case"KeyA":case"KeyD":break;case"KeyS":m.game.down();break;case"Space":m.renderer.action()}}(e.code)})),document.addEventListener("keyup",(e=>{const t=p.length;1==t?(u(0,0),p.splice(0,1)):p.some(((i,s)=>i==e.code&&(p.splice(s,1),t>=2&&f(p[p.length-1]),!0)))})),document.getElementById("canvas").addEventListener("click",(e=>{let t=e.offsetX/m.canvasScale,i=e.offsetY/m.canvasScale;m.onclick(t,i)}))})();