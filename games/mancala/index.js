(()=>{"use strict";class e{static timescale=1;id=0;time=0;initialize(){}update(e){}completed(){}repeatMode="restart";static defaultEasing=e=>e;constructor(){}start(t){const n=(t=t||{}).easing||e.defaultEasing;let s=t.time||this.time;s*=e.timescale,this.initialize();let i=this.id;return new Promise((e=>{const r=this,a=t.times?t.times:1;let o=0,l="flap"==this.repeatMode,c=performance.now(),h=!1;!function t(d){if(i!=r.id)return e(),void r.completed();if(d-c>=s&&(r.update(h?0:1),++o==a))return e(),void r.completed();h=l&&o%2==1;let p=Math.max((d-c)/s,0);r.update(n(h?1-p:p)),requestAnimationFrame(t)}(c)}))}stop(){this.id++}static async direct(t,n,s){let i=new e;i.update=t,i.time=n,await i.start(s)}static async sleep(t){await e.direct((()=>{}),t)}}class t{constructor(e,t,n){this.players_number=e,this.term=t,this.seeds_number=n,this.length=this.term*this.players_number,this.seeds_total=this.players_number*this.seeds_number*(this.term-1),this.stage=null,this.present=0,this.next=1,this.set_stage()}set_stage(){this.stage=Array(this.length).fill(this.seeds_number);for(let e=0;e<this.players_number;e++)this.stage[(e+1)*this.term-1]=0}pick(e){if(!this.is_pickable(e))return;const t=this.stage,n=t[e],s=e+n,i=this.what_event(e,s);t[e]=0;for(let s=0;s<n;s++)t[(e+s+1)%(this.term*this.players_number)]++;return i.can_steal&&this.steal_seeds(s),i.can_redo||this.shift_turn(),i}is_pickable(e){return e%this.term!=this.term-1&&(this.get_player_id(e)===this.present&&0!==this.stage[e])}what_event(e,t,n=this.present){t=this.get_clamped_id(t);const s={},i=this.get_player_id(t);return s.is_empty=0===this.stage[e],s.is_score=(e+1)%this.term==0,s.can_redo=(t+1)%this.term==0&&i===n,s.can_steal=0===this.stage[t]&&i===n&&!s.can_redo,s}get_player_id(e){return e=this.get_clamped_id(e),Math.floor(e%this.length/this.term)}get_clamped_id(e){if(0<=e&&e<this.length)return e;const t=e%this.length;return t>=0?t:t+this.length}steal_seeds(e){const t=this.get_beside(e),n=this.stage[e]+this.stage[t],s=(this.get_player_id(e)+1)*this.term-1;this.stage[s]+=n,this.stage[e]=0,this.stage[t]=0}get_beside(e){if((e+1)%this.term==0)return;return(e=>this.term*(Math.floor((e-2)/this.term+this.players_number-1)%(this.players_number-1))+2*this.term-4)(e)+(e=>(e-2+this.term)%this.term*-1)(e)+(e=>-1*this.term*Math.floor((e-2)/(this.term*(this.players_number-1))))(e)}shift_turn(){this.present=(this.present+this.next)%this.players_number}is_finished(){return this.stage.every(((e,t)=>0===e||t%this.term==this.term-1))}}const n=document.getElementById("canvas"),s=document.getElementById("canvas_wrapper"),i=document.getElementById("stones"),r=document.getElementById("pocket_numbers"),a={stone:null,background:null,pocket:null,pocket_corner:null,green_sheet:null,board:null},o={pocket:null,pocket_corner:null,green_sheet:null,board:null};let l,c,h,d,p,u,g,y,_,f,m=n.getContext("2d"),x=null,w=[],k=!1,b=!1;function v(){p=Number.parseFloat(getComputedStyle(n).width),u=Number.parseFloat(getComputedStyle(n).height),g=p*window.devicePixelRatio,y=u*window.devicePixelRatio,_=Math.min(g,y),n.width=g,n.height=y,f=function(){const e=[];let t=1/0,n=-1/0;for(let s=0;s<d.stage.length;s++){const i=R(s);e.push(i),t=Math.min(t,i.y),n=Math.max(n,i.y)}const s=(1-n-t)/2,i=[];for(const t of e){let n=t.x,r=t.y+s;const a=N(),o=a/_;if(2==l){[n,r]=[r,n];const s=e.indexOf(t),i=d.get_player_id(s);s%c!=c-1&&(r+=2*(i-.5)*o*2)}const h=n*_+(g-_)/2,p=r*_+(y-_)/2;i.push({x:h,y:p,rx:n,ry:r,radius:a,rradius:o})}return i}(),m=n.getContext("2d"),m.lineJoin="round",g>y?(s.style.width="",s.style.height="100%"):(s.style.width="100%",s.style.height=""),s.style.fontSize=.03*_/window.devicePixelRatio+"px",T()}function M(){r.innerHTML="";for(let e=0;e<f.length;e++){const t=f[e],n=document.createElement("div");if(n.className="pocket-number",n.style.fontWeight=e%c==c-1?800:600,b){const s=B(d.get_player_id(e));n.style.left=100*(t.rx-Math.sin(s)*t.rradius*.8)+"%",n.style.top=100*(t.ry+Math.cos(s)*t.rradius*.8)+"%",n.style.transform=`translate(-50%, -50%) rotate(${s}rad)`}else n.style.left=100*t.rx+"%",n.style.top=100*(t.ry+.8*t.rradius)+"%",n.style.transform="translate(-50%, -50%)";r.appendChild(n)}v()}function E(e){b?(happen_message.style.transform=`translate(-50%, -50%) rotate(${B(e)}rad)`,kokomade.style.transform=`translate(-50%, -50%) rotate(${B(e)}rad)`):(happen_message.style.transform="translate(-50%, -50%)",kokomade.style.transform="translate(-50%, -50%)")}function P(e){if(k)return;const t=e.offsetX*g/p,n=e.offsetY*y/u,s=f.findIndex((e=>(t-e.x)**2+(n-e.y)**2<(1.2*e.radius)**2));-1!=s&&d.get_player_id(s)==d.present?function(e){const t=d.get_player_id(e),n=(e+d.stage[e])%d.length,s=d.stage[e],i=[e,n],r=d.get_beside(n),a=(e,n)=>{const s={player_id:t};s.highlights=n,s.status=e,I(s),E(t),T()},o=d.what_event(e,n,t);if(o.is_score)return a(`${t+1}Pのいまのスコアは ${s}pt`,[e]);if(o.is_empty)return a("ここは選べません",[e]);if(o.can_redo)return a("蒔きながら、もう一度行動出来ます",i);if(o.can_steal)return i.push(r),a("蒔きながら、繋がるマスから横取り",i);a(s+"個を先のマスに一つずつ蒔く",i)}(s):I(null)}function I(e){if(e){if(e.highlights.length>=2){const t=f[e.highlights[1]];kokomade.style.left=100*t.rx+"%",kokomade.style.top=100*t.ry+"%",kokomade.hidden=!1}else kokomade.hidden=!0;happen_message.style.borderColor=`${h[e.player_id]}`,happen_message_label.innerText=e.status,happen_message.hidden=!1}else kokomade.hidden=!0,happen_message.hidden=!0;x=e,T()}async function L(t){if(k)return;k=!0;const n=t.offsetX*g/p,s=t.offsetY*y/u,i=f.findIndex((e=>(n-e.x)**2+(s-e.y)**2<e.radius**2));-1!=i&&d.is_pickable(i)&&(I(null),T(),await async function(t){const n=d.present,s=t+1,i=d.stage[t],r=s+i-1,a=await C(w[t]);w[t]=[],await async function(t,n,s){for(let i=0;i<s;i++){const s=t[i],r=(n+i)%d.stage.length,a=d.stage[r],o=[];o.push(S(r,a+1));const l=s.x,c=s.y,h=z(r,a+1,a).x,p=z(r,a+1,a).y;o.push(e.direct((e=>{s.x=l+(h-l)*e,s.y=c+(p-c)*e,s.update_position()}),250)),await Promise.all(o),w[r].push(s)}}(a,s,i);const o=d.pick(t);T(),o.can_redo&&await D(d.present,"もう一度");o.can_steal&&await async function(t,n){const s=d.get_beside(n),i=(t+1)*c-1,r=w[s].length,a=d.get_player_id(s);if(r>0){const e=`${a+1}P から ${r}個の石をうばいます`;await D(t,"横取り！",e)}const o=[w[n][0]];o.push(...w[s]),w[n]=[],w[s]=[],await C(o),await async function(t,n){for(let s=0;s<t.length;s++){const i=t[s],r=[],a=w[n].length;r.push(S(n,a+1));const o=i.x,l=i.y,c=z(n,a+1,a).x,h=z(n,a+1,a).y;r.push(e.direct((e=>{i.x=o+(c-o)*e,i.y=l+(h-l)*e,i.update_position()}),250)),await Promise.all(r),w[n].push(i)}}(o,i)}(n,r);for(let e=0;e<d.stage.length;e++)if(w[e].length!=d.stage[e])throw new Error("DOM と seed データに矛盾を発見");function p(){const e=d.present;let t=!0;for(let n=e*c;n<(e+1)*c-1;n++)0!=d.stage[n]&&(t=!1);return t}if(d.is_finished())await async function(){await D(null,"終了！");const t=[];for(let e=0;e<l;e++)t.push(e);const n=d.stage.filter(((e,t)=>t%c==c-1)),s=n.toSorted(((e,t)=>e<t));t.sort(((e,t)=>n[e]<=n[t]));for(const e of ranking_rows.children)e.style.height="0";ranking_rows.innerHTML="";for(let e=0;e<l;e++){const i=document.createElement("div");i.className="ranking-row";const r=t[e];let a=["#e59936","#90b8c8","#c5693c"][e];for(let t=e-1;t>=0;t--)s[e]==s[t]&&(a=["#e59936","#90b8c8","#c5693c"][t]);const o=document.createElement("div");o.className="ranking-crown",o.innerText=null==a?"":"crown",o.style.color=a,i.appendChild(o);const l=document.createElement("div");l.className="ranking-icon",l.style.background=h[r],i.appendChild(l);const c=document.createElement("div");c.className="ranking-label",c.innerText=`${r+1}P`,i.appendChild(c);const d=document.createElement("div");d.className="ranking-points",d.innerText=n[r],i.appendChild(d),ranking_rows.appendChild(i)}ranking.hidden=!1,await e.direct((e=>{ranking.style.opacity=e}),500)}();else for(;p();)await D(d.present,"パス","動かせる石がありません"),d.shift_turn(),T()}(i)),k=!1}async function C(t){const n=[];for(let s=0;s<t.length;s++){const i=t[s],r=i.x,a=i.y,o=W(t.length,s),l=.5+o.x-r,c=.5+o.y-a;n.push(e.direct((e=>{i.x=r+l*e,i.y=a+c*e,i.update_position()}),250)),await e.sleep(100)}return await Promise.all(n),t}async function S(t,n){const s=[];for(let i=0;i<w[t].length;i++){const r=w[t][i],a=r.x,o=r.y,l=z(t,n,i).x,c=z(t,n,i).y;s.push(e.direct((e=>{r.x=a+(l-a)*e,r.y=o+(c-o)*e,r.update_position()}),200))}await Promise.all(s)}function T(){let e;if(present.style.borderColor=h[d.present],present_icon.style.background=h[d.present],present_label.innerText=d.present+1+"Pのターン",m.clearRect(0,0,n.width,n.height),m.drawImage(a.background,0,0,n.width,n.height),m.fillStyle=o.board,m.strokeStyle=o.board,m.lineWidth=3*N(),m.beginPath(),2==l){const t=f[f.length-1].x,n=f[0].y,s=f[c-1].x,i=f[c].y;e=[{x:t,y:n},{x:s,y:n},{x:s,y:i},{x:t,y:i}]}else e=f.filter(((e,t)=>(t+1)%c==0));for(const t of e)m.lineTo(t.x,t.y);m.closePath(),m.fill(),m.stroke(),x&&x.highlights.length>=2&&($(x.highlights[0],!0),$(x.highlights[1],!1));for(let e=0;e<d.stage.length;e++){const t=f[e],n=Math.floor(e/c),s=!!x&&x.highlights.some((t=>t===e));m.beginPath(),m.arc(t.x,t.y,.9*t.radius,0,2*Math.PI),m.fillStyle=e%c==c-1?o.pocket_corner:o.pocket,m.fill();const i=m.createRadialGradient(t.x,t.y,.3*t.radius,t.x,t.y,t.radius);i.addColorStop(0,"#4f231000"),i.addColorStop(1,"#4f231080"),m.fillStyle=i,m.fill(),s&&(m.strokeStyle="#ffffff88",m.lineWidth=.35*t.radius,m.stroke()),m.strokeStyle="#00000088",m.lineWidth=.15*t.radius,m.stroke(),m.strokeStyle=h[n],m.lineWidth=.1*t.radius,m.stroke(),0!=r.children.length&&(r.children[e].innerText=d.stage[e]||"")}}function $(e,t){m.strokeStyle="#00000088",t?(m.lineWidth=.05*N(),m.setLineDash([5,8])):(m.lineWidth=.05*N(),m.setLineDash([])),m.lineWidth=.1*N();for(let t=0;t<d.stage.length;t++){const n=d.get_beside(t);if(t!=e)continue;const s=f[t],i=f[n];s&&i&&(m.beginPath(),m.moveTo(s.x,s.y),m.lineTo(i.x,i.y),m.stroke())}m.setLineDash([])}function N(){const e=Math.cos(2*Math.PI/l),t=Math.sin(2*Math.PI/l);return Math.sqrt((1-e)**2+(0-t)**2)/c/4*_*.84}function z(e,t,n){const s=f[e],i=W(t,n);return{x:s.rx+i.x,y:s.ry+i.y}}function W(e,t){const n=f[0].rradius;let s,i;return e<5?(s=(t%2==0?-1:1)*n*.3,i=(t-(e-1)/2)/e*n):(s=(t%3-1)*n*.3,i=(t-(e-1)/2)/e*n),{x:s,y:i}}function R(e){e=d.stage.length-e-1;const t=Math.floor(e/c),n=(t+1)%l,s=e%c/c,i=2*Math.PI/l;let r,a;if(4==l){const e=1/Math.sqrt(2),s=[[-e,-e],[e,-e],[e,e],[-e,e]];r={x:s[t][0],y:s[t][1]},a={x:s[n][0],y:s[n][1]}}else r={x:-Math.sin(i*t),y:Math.cos(i*t)},a={x:-Math.sin(i*n),y:Math.cos(i*n)};const o=a.x-r.x,h=a.y-r.y,p={x:r.x+o*s,y:r.y+h*s};p.x*=.84,p.y*=.84;return{x:(p.x+1)/2,y:1-(p.y+1)/2}}function B(e){return 2==l?1==e?0:Math.PI:4==l?(e+1)*Math.PI/2%(2*Math.PI):2*Math.PI/l*(e+.5)+Math.PI}async function D(t,n,s=""){event_popup.hidden=!1,event_popup_icon.hidden=null==t,null!=t&&(event_popup_icon.style.background=h[t]),event_popup_label.innerText=n,event_popup_description.innerText=s,await e.direct((e=>{event_popup_content.style.transform=`scale(${1.5-.5*e})`,event_popup.style.opacity=e}),300),await e.sleep(800),await e.direct((e=>{event_popup_content.style.transform=`scale(${1+.5*e})`,event_popup.style.opacity=1-e}),300),event_popup.hidden=!0}!async function(){e.defaultEasing=e=>(1-Math.cos(e*Math.PI))/2,await async function(){function e(e){const t=new Image;return new Promise((n=>{t.onload=()=>n(t),t.src=e}))}a.stone=await e("resources/stone.png"),a.background=await e("resources/background.png"),a.pocket=await e("resources/pocket.png"),a.pocket_corner=await e("resources/pocket_corner.png"),a.green_sheet=await e("resources/green_sheet.png"),a.board=await e("resources/board.png")}(),o.pocket=m.createPattern(a.pocket,"repeat"),o.pocket_corner=m.createPattern(a.pocket_corner,"repeat"),o.green_sheet=m.createPattern(a.green_sheet,"repeat"),o.board=m.createPattern(a.board,"repeat"),title_start.addEventListener("click",(()=>{l=Number(title_players_select.value),c=Number(title_term_select.value),async function(){title_start.style.pointerEvents="none",ranking_to_title.style.pointerEvents="",game_wrapper.hidden=!1,d=new t(l,c,4),h=function(){const e=[];for(let t=0;t<l;t++){const n=`lch(60% 60% ${t/l*360}deg)`;e.push(n)}return e}(),window.addEventListener("resize",v),n.addEventListener("click",P),n.addEventListener("dblclick",L),v(),function(){i.innerHTML="",w=[];for(let e=0;e<d.stage.length;e++){const t=d.stage[e],n=f[e],s=[];for(let r=0;r<t;r++){const a=document.createElement("div");a.className="stone",a.style.width=.4*n.rradius*100+"%",a.style.height=.4*n.rradius*100+"%";const o=new Image;o.src="resources/stone.png",o.style.filter=`hue-rotate(${360*Math.random()}deg)`,a.appendChild(o),a.x=z(e,t,r).x,a.y=z(e,t,r).y,a.update_position=()=>{a.style.left=100*a.x+"%",a.style.top=100*a.y+"%"},a.update_position(),s.push(a),i.appendChild(a)}w.push(s)}}(),M(),T(),title_wrapper.style.zIndex=1e7,await e.direct((e=>{title_wrapper.style.opacity=""+(1-e)}),500),title_wrapper.style.opacity=1,title_wrapper.style.zIndex=null,title_wrapper.hidden=!0,await D(null,"スタート！")}()})),pass.addEventListener("click",(async()=>{await D(d.present,"パス"),d.present=(d.present+1)%l,T()})),text_turning_checkbox.addEventListener("change",(()=>{b=text_turning_checkbox.checked,M(),E(d.present)})),text_turning_button.addEventListener("click",(()=>{text_turning_checkbox.checked=!text_turning_checkbox.checked,text_turning_checkbox.dispatchEvent(new Event("change"))})),ranking_to_title.addEventListener("click",(()=>{!async function(){ranking_to_title.pointerEvents="none",title_wrapper.hidden=!1,game_wrapper.style.zIndex=1e7,await e.direct((e=>{game_wrapper.style.opacity=""+(1-e)}),500),game_wrapper.style.opacity=1,game_wrapper.style.zIndex=null,game_wrapper.hidden=!0,ranking.hidden=!0,title_start.style.pointerEvents="",window.removeEventListener("resize",v),n.removeEventListener("click",P),n.removeEventListener("dblclick",L)}()}))}()})();