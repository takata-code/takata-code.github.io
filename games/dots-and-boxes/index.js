(()=>{"use strict";class e{static timescale=1;id=0;time=0;initialize(){}update(e){}completed(){}repeatMode="restart";static defaultEasing=e=>e;constructor(){}start(t){const n=(t=t||{}).easing||e.defaultEasing;let i=t.time||this.time;i*=e.timescale,this.initialize();let a=this.id;return new Promise((e=>{const s=this,l=t.times?t.times:1;let r=0,o="flap"==this.repeatMode,c=performance.now(),d=!1;!function t(p){if(a!=s.id)return e(),void s.completed();if(p-c>=i&&(s.update(d?0:1),++r==l))return e(),void s.completed();d=o&&r%2==1;let u=Math.max((p-c)/i,0);s.update(n(d?1-u:u)),requestAnimationFrame(t)}(c)}))}stop(){this.id++}static async direct(t,n,i){let a=new e;a.update=t,a.time=n,await a.start(i)}static async sleep(t){await e.direct((()=>{}),t)}}class t{static STAGE_LINE=0;width=0;height=0;players=0;#e=null;constructor(e,t,n){this.width=e,this.height=t,this.players=n,this.initialize_stage()}initialize_stage(){this.#e=[];for(let e=0;e<this.height;e++)this.#e.push(Array(this.width).fill(null))}draw_line(e,n,i){return this.#e[n][e]=t.STAGE_LINE,this.fill_squares_if_needed(i)}fill_squares_if_needed(e){const t=[];for(let n=0;n<(this.height-1)/2;n++)for(let i=0;i<(this.width-1)/2;i++){const a=2*i+1,s=2*n+1;if(this.is_closed(a,s)){if(null!=this.#e[s][a])continue;this.#e[s][a]=e,t.push({x:a,y:s})}}return t}is_lined(e,n){return this.#e[n][e]==t.STAGE_LINE}is_closed(e,t){const n=[[1,0],[0,1],[-1,0],[0,-1]];for(const i of n)if(null==this.#e[t+i[1]][e+i[0]])return!1;return!0}get is_filled(){return this.get_all_square_map().flat().length==(this.width-1)/2*(this.height-1)/2}get_all_square_map(){const e=[];for(let t=0;t<this.players;t++)e.push([]);for(let t=0;t<(this.height-1)/2;t++)for(let n=0;n<(this.width-1)/2;n++){const i=2*n+1,a=2*t+1,s=this.#e[a][i];null!=s&&e[s].push({x:i,y:a})}return e}}let n;const i=document.getElementById("canvas"),a=120,s=200,l={background:null,paper:null,green_sheet:null,board:null},r={paper:null};let o,c,d,p,u,h,y,_,f=i.getContext("2d"),x=!1,g=null;function m(){const e=u/h,t=window.innerWidth/window.innerHeight;canvas_frame.style.aspectRatio=`${e}`,t>e?(canvas_frame.style.width="",canvas_frame.style.height="100%"):(canvas_frame.style.width="100%",canvas_frame.style.height="");const n=getComputedStyle(canvas_frame).width;y=Number.parseFloat(n)/u}function w(){present.style.borderColor=p[_],present_label.innerText=`${_+1}Pのターンです`}async function v(t){if(x)return;x=!0;const l=i.getBoundingClientRect(),y=function(e,t){const n=function(e,t,n=!0){const i={x:(e-a)/s*2,y:(t-a)/s*2};return n?C(i):i}(e,t,!1),i=2*Math.round((n.x-1)/2)+1,l=2*Math.round((n.y-1)/2)+1,r=n.x-i,d=n.y-l;let p,u;Math.abs(r)>Math.abs(d)?(p=Math.sign(r),u=0):(p=0,u=Math.sign(d));const h=i+p,y=l+u;return 0<=h&&h<2*o+1&&0<=y&&y<2*c+1?{x:h,y}:null}(t.offsetX/l.width*u,t.offsetY/l.height*h);if(!y||n.is_lined(y.x,y.y))return b(null),void(x=!1);const m=g;m&&y.x==m.x&&y.y==m.y?(b(null),await async function(t){const a=T(t),s=a[0],l=a[1];let o=N(s.x,s.y),c=N(l.x,l.y);o=L(o,6),c=L(c,6),f.strokeStyle=p[_],f.lineWidth=10,await E(o,c,300);const u=n.draw_line(t.x,t.y,_);if(u.length>0){for(const e of u)await k(e);n.is_filled&&async function(){await M(null,"終了！");const t=n.get_all_square_map();await async function(t){f.font=`bold 120px ${getComputedStyle(i).fontFamily}`,f.lineWidth=20;const n=Math.max(...t.map((e=>e.length)));for(let i=0;i<n;i++){for(let e=0;e<d;e++){const n=t[e][i];if(n){const a=N(n.x/2,n.y/2),s=i==t[e].length-1;f.fillStyle=s?"yellow":r.paper,f.strokeStyle=p[e];const l=f.measureText(i+1);f.strokeText(i+1,a.x-l.width/2,a.y+50),f.fillText(i+1,a.x-l.width/2,a.y+50)}}await e.sleep(300)}await e.sleep(1e3)}(t);const a=t.map((e=>e.length));await async function(t){const n=t.toSorted(((e,t)=>e<t)),i=[];for(let e=0;e<d;e++)i.push(e);i.sort(((e,n)=>t[e]<=t[n])),ranking_rows.innerHTML="";for(let e=0;e<d;e++){const a=document.createElement("div");a.className="ranking-row";const s=i[e];let l=["#e59936","#90b8c8","#c5693c"][e];for(let t=e-1;t>=0;t--)n[e]==n[t]&&(l=["#e59936","#90b8c8","#c5693c"][t]);const r=document.createElement("div");r.className="ranking-crown",r.innerText=null==l?"":"crown",r.style.color=l,a.appendChild(r);const o=document.createElement("div");o.className="ranking-icon",o.style.background=p[s],a.appendChild(o);const c=document.createElement("div");c.className="ranking-label",c.innerText=`${s+1}P`,a.appendChild(c);const d=document.createElement("div");d.className="ranking-points",d.innerText=t[s],a.appendChild(d),ranking_rows.appendChild(a)}ranking.hidden=!1,await e.direct((e=>{ranking.style.opacity=e}),500)}(a)}()}else _=(_+1)%d,w()}(y)):b(y),x=!1}function b(e){if(g=e,!e)return void(selected_line_box.hidden=!0);const t=T(e)[0],n=T(e)[1],i=N(t.x,t.y),a=N(n.x,n.y),l=i.y==a.y,r=s*y;selected_line_box.style.left=i.x/u*100+"%",selected_line_box.style.top=i.y/h*100+"%",selected_line_box.style.width=r*Number(l)+"px",selected_line_box.style.height=r*Number(!l)+"px",selected_line_box.style.border=`${.05*r}px dashed ${p[_]}`,selected_line_box.style.transform=`translate(${l?"0, -50%":"-50%, 0"})`,selected_line_box.hidden=!1}async function k(e){const t={x:(e.x-1)/2,y:(e.y-1)/2},n=N(t.x,t.y),i={x:n.x+s,y:n.y+s},a={x:i.x,y:n.y},l={x:n.x,y:i.y},r=(n.x+a.x)/2,o=(n.y+l.y)/2;let c=[];for(let e=0;e<5;e++)c.push(z(n,a,e/5)),c.push(z(n,l,e/5));for(let e=0;e<5;e++)c.push(z(a,i,e/5)),c.push(z(l,i,e/5));c=c.map((e=>{e=L(e,6);const t=.75+.15*Math.random();return e.x=I(r,e.x,t),e.y=I(o,e.y,t),e}));for(let e=2;e<c.length-1;e++)await E(c[e],c[e+1],40)}async function E(t,n,i){let a=t.x,s=t.y;const l=f.lineWidth;await e.direct((e=>{f.lineWidth=l*(1+.5*(Math.random()-.5));const i=z(t,n,e).x,r=z(t,n,e).y;f.beginPath(),f.moveTo(a,s),f.lineTo(i,r),f.stroke(),a=i,s=r}),i),f.lineWidth=l}async function M(t,n,i=""){event_popup.hidden=!1,event_popup_icon.hidden=null==t,null!=t&&(event_popup_icon.style.background=p[t]),event_popup_label.innerText=n,event_popup_description.innerText=i,await e.direct((e=>{event_popup_content.style.transform=`scale(${1.5-.5*e})`,event_popup.style.opacity=e}),300),await e.sleep(800),await e.direct((e=>{event_popup_content.style.transform=`scale(${1+.5*e})`,event_popup.style.opacity=1-e}),300),event_popup.hidden=!0}function T(e){let t;return t=e.y%2==0?[{x:e.x-1,y:e.y},{x:e.x+1,y:e.y}]:[{x:e.x,y:e.y-1},{x:e.x,y:e.y+1}],t.map((e=>({x:e.x/2,y:e.y/2})))}function N(e,t){return{x:a+e*s,y:a+t*s}}function C(e){return{x:Math.floor(e.x),y:Math.floor(e.y)}}function L(e,t){return{x:e.x+(Math.random()-.5)*t*2,y:e.y+(Math.random()-.5)*t*2}}function z(e,t,n){return{x:I(e.x,t.x,n),y:I(e.y,t.y,n)}}function I(e,t,n){return e+(t-e)*n}!async function(){e.defaultEasing=e=>(1-Math.cos(e*Math.PI))/2,await async function(){function e(e){const t=new Image;return new Promise((n=>{t.onload=()=>n(t),t.src=e}))}l.background=await e("resources/background.png"),l.paper=await e("resources/paper.png")}(),await void(r.paper=f.createPattern(l.paper,"repeat")),title_wrapper.hidden=!1,loading_wrapper.hidden=!0,title_start.addEventListener("click",(()=>{const a=title_players_select.value,l=title_size_select.value;d=Number(a),o=Number(l.split("x")[0]),c=Number(l.split("x")[1]),async function(){title_start.style.pointerEvents="none",ranking_to_title.style.pointerEvents="",game_wrapper.hidden=!1,n=new t(2*o+1,2*c+1,d),p=function(){const e=[];for(let t=0;t<d;t++){const n=`lch(60% 60% ${t/d*360}deg)`;e.push(n)}return e}(),_=0,function(){u=o*s+240,h=c*s+240,i.width=u,i.height=h,f=i.getContext("2d"),f.lineCap="round",m(),window.addEventListener("resize",m),i.addEventListener("click",v),f.strokeStyle="#aaaaaa",f.lineWidth=6,f.setLineDash([6,16]);for(let e=0;e<o+1;e++){const t=N(e,0),n=N(e,c);f.beginPath(),f.moveTo(t.x,t.y),f.lineTo(n.x,n.y),f.stroke()}for(let e=0;e<c+1;e++){const t=N(0,e),n=N(o,e);f.beginPath(),f.moveTo(t.x,t.y),f.lineTo(n.x,n.y),f.stroke()}f.setLineDash([]),f.fillStyle="#333333";const e=10;for(let t=0;t<c+1;t++)for(let n=0;n<o+1;n++){const i=N(n,t);f.beginPath(),f.arc(i.x,i.y,e,0,2*Math.PI),f.fill()}}(),w(),title_wrapper.style.zIndex=1e7,await e.direct((e=>{title_wrapper.style.opacity=""+(1-e)}),500),title_wrapper.style.opacity=1,title_wrapper.style.zIndex=null,title_wrapper.hidden=!0,await M(null,"スタート！")}()})),ranking_to_title.addEventListener("click",(()=>{!async function(){ranking_to_title.pointerEvents="none",title_wrapper.hidden=!1,game_wrapper.style.zIndex=1e7,await e.direct((e=>{game_wrapper.style.opacity=""+(1-e)}),500),game_wrapper.style.opacity=1,game_wrapper.style.zIndex=null,game_wrapper.hidden=!0,ranking.hidden=!0,title_start.style.pointerEvents="",window.removeEventListener("resize",m),i.removeEventListener("click",v)}()}))}()})();