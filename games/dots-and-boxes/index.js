(()=>{"use strict";class e{static timescale=1;id=0;time=0;initialize(){}update(e){}completed(){}repeatMode="restart";static defaultEasing=e=>e;constructor(){}start(t){const n=(t=t||{}).easing||e.defaultEasing;let i=t.time||this.time;i*=e.timescale,this.initialize();let s=this.id;return new Promise((e=>{const o=this,l=t.times?t.times:1;let a=0,r="flap"==this.repeatMode,c=performance.now(),d=!1;!function t(h){if(s!=o.id)return e(),void o.completed();if(h-c>=i&&(o.update(d?0:1),++a==l))return e(),void o.completed();d=r&&a%2==1;let _=Math.max((h-c)/i,0);o.update(n(d?1-_:_)),requestAnimationFrame(t)}(c)}))}stop(){this.id++}static async direct(t,n,i){let s=new e;s.update=t,s.time=n,await s.start(i)}static async sleep(t){await e.direct((()=>{}),t)}}class t{constructor(e,t,n){this.w_boxes=(e-1)/2,this.h_boxes=(t-1)/2,this.l_boxes=this.w_boxes*this.h_boxes,this.boxes=Array(this.l_boxes).fill(null),this.players=n,this.w_lines=this.w_boxes+1,this.h_lines=this.h_boxes+1,this.l_lines=this.w_boxes*this.h_lines+this.h_boxes*this.w_lines,this.lines=Array(this.l_lines).fill(!1)}get_lines_xy(e){const t=2*this.w_lines-1,n=e%t;return{x:2*n+1-(2*this.w_boxes+1)*Number(n>=this.w_boxes),y:2*Math.floor(e/t)+Number(e%t-this.w_lines+2>0)}}get_lines_id(e,t){return Math.floor(e/2)+(Math.floor(t/2)*(this.w_boxes+this.w_lines)+t%2*this.w_boxes)}get_boxes_xy(e){return{x:e%this.w_boxes,y:Math.floor(e/this.w_boxes)}}get_boxes_id(e,t){return e+t*this.w_lines}in_box_area(e,t){return 0<=e&&e<this.w_boxes&&0<=t&&t<=this.h_boxes}in_lines_area(e){return 0<=e&&e<this.l_lines}get_beside(e,t){const n=e+(this.w_boxes+this.w_lines)*t,i=n+this.w_boxes;return{bottom:n,left:i,right:i+1,top:n+this.w_boxes+this.w_lines}}draw_line(e,t,n){const i=this.get_lines_id(e,t);return this.lines[i]=!0,this.fill_squares_if_needed(n)}fill_squares_if_needed(e){const t=[];for(let n=0;n<this.h_boxes;n++)for(let i=0;i<this.w_boxes;i++){const s=2*i+1,o=2*n+1;if(this.is_closed(s,o)){const n=this.get_boxes_id(s,o);if(null!=this.boxes[n])continue;this.boxes[n]=e,t.push({x:s,y:o})}}return t}is_lined(e,t){return 1==this.lines[this.get_lines_id(e,t)]}is_closed(e,t){const n=[[1,0],[0,1],[-1,0],[0,-1]];for(const i of n){const n=this.get_lines_id(e+i[0],t+i[1]);if(0==this.lines[n])return!1}return!0}get is_filled(){return this.get_all_square_map().flat().length==this.l_boxes}get_all_square_map(){const e=[];for(let t=0;t<this.players;t++)e.push([]);for(let t=0;t<this.h_boxes;t++)for(let n=0;n<this.w_boxes;n++){const i=2*n+1,s=2*t+1,o=this.boxes[this.get_boxes_id(i,s)];null!=o&&e[o].push({x:i,y:s})}return e}}const n=document.getElementById("canvas"),i=120,s=200,o={background:null,paper:null,green_sheet:null,board:null},l={paper:null};let a,r,c,d,h,_,p,u,y,x=n.getContext("2d"),f=!1,w=null;function m(){const e=_/p,t=window.innerWidth/window.innerHeight;canvas_frame.style.aspectRatio=`${e}`,t>e?(canvas_frame.style.width="",canvas_frame.style.height="100%"):(canvas_frame.style.width="100%",canvas_frame.style.height="");const n=getComputedStyle(canvas_frame).width;u=Number.parseFloat(n)/_}function g(){present.style.borderColor=h[y],present_label.innerText=`${y+1}Pのターンです`}async function b(t){if(f)return;f=!0;const o=n.getBoundingClientRect(),u=function(e,t){const n=function(e,t,n=!0){const o={x:(e-i)/s*2,y:(t-i)/s*2};return n?C(o):o}(e,t,!1),o=2*Math.round((n.x-1)/2)+1,l=2*Math.round((n.y-1)/2)+1,a=n.x-o,d=n.y-l;let h,_;Math.abs(a)>Math.abs(d)?(h=Math.sign(a),_=0):(h=0,_=Math.sign(d));const p=o+h,u=l+_;return 0<=p&&p<2*r+1&&0<=u&&u<2*c+1?{x:p,y:u}:null}(t.offsetX/o.width*_,t.offsetY/o.height*p);if(!u||a.is_lined(u.x,u.y))return v(null),void(f=!1);const m=w;m&&u.x==m.x&&u.y==m.y?(v(null),await async function(t){const i=T(t),s=i[0],o=i[1];let r=N(s.x,s.y),c=N(o.x,o.y);r=P(r,6),c=P(c,6),x.strokeStyle=h[y],x.lineWidth=10,await M(r,c,300);const _=a.draw_line(t.x,t.y,y);if(_.length>0){for(const e of _)await k(e);a.is_filled&&async function(){await E(null,"終了！");const t=a.get_all_square_map();await async function(t){x.font=`bold 120px ${getComputedStyle(n).fontFamily}`,x.lineWidth=20;const i=Math.max(...t.map((e=>e.length)));for(let n=0;n<i;n++){for(let e=0;e<d;e++){const i=t[e][n];if(i){const s=N(i.x/2,i.y/2),o=n==t[e].length-1;x.fillStyle=o?"yellow":l.paper,x.strokeStyle=h[e];const a=x.measureText(n+1);x.strokeText(n+1,s.x-a.width/2,s.y+50),x.fillText(n+1,s.x-a.width/2,s.y+50)}}await e.sleep(300)}await e.sleep(1e3)}(t);const i=t.map((e=>e.length));await async function(t){const n=t.toSorted(((e,t)=>e<t)),i=[];for(let e=0;e<d;e++)i.push(e);i.sort(((e,n)=>t[e]<=t[n])),ranking_rows.innerHTML="";for(let e=0;e<d;e++){const s=document.createElement("div");s.className="ranking-row";const o=i[e];let l=["#e59936","#90b8c8","#c5693c"][e];for(let t=e-1;t>=0;t--)n[e]==n[t]&&(l=["#e59936","#90b8c8","#c5693c"][t]);const a=document.createElement("div");a.className="ranking-crown",a.innerText=null==l?"":"crown",a.style.color=l,s.appendChild(a);const r=document.createElement("div");r.className="ranking-icon",r.style.background=h[o],s.appendChild(r);const c=document.createElement("div");c.className="ranking-label",c.innerText=`${o+1}P`,s.appendChild(c);const d=document.createElement("div");d.className="ranking-points",d.innerText=t[o],s.appendChild(d),ranking_rows.appendChild(s)}ranking.hidden=!1,await e.direct((e=>{ranking.style.opacity=e}),500)}(i)}()}else y=(y+1)%d,g()}(u)):v(u),f=!1}function v(e){if(w=e,!e)return void(selected_line_box.hidden=!0);const t=T(e)[0],n=T(e)[1],i=N(t.x,t.y),o=N(n.x,n.y),l=i.y==o.y,a=s*u;selected_line_box.style.left=i.x/_*100+"%",selected_line_box.style.top=i.y/p*100+"%",selected_line_box.style.width=a*Number(l)+"px",selected_line_box.style.height=a*Number(!l)+"px",selected_line_box.style.border=`${.05*a}px solid ${h[y]}`,selected_line_box.style.transform=`translate(${l?"0, -50%":"-50%, 0"})`,selected_line_box.hidden=!1}async function k(e){const t={x:(e.x-1)/2,y:(e.y-1)/2},n=N(t.x,t.y),i={x:n.x+s,y:n.y+s},o={x:i.x,y:n.y},l={x:n.x,y:i.y},a=(n.x+o.x)/2,r=(n.y+l.y)/2;let c=[];for(let e=0;e<5;e++)c.push($(n,o,e/5)),c.push($(n,l,e/5));for(let e=0;e<5;e++)c.push($(o,i,e/5)),c.push($(l,i,e/5));c=c.map((e=>{e=P(e,6);const t=.75+.15*Math.random();return e.x=z(a,e.x,t),e.y=z(r,e.y,t),e}));for(let e=2;e<c.length-1;e++)await M(c[e],c[e+1],40)}async function M(t,n,i){let s=t.x,o=t.y;const l=x.lineWidth;await e.direct((e=>{x.lineWidth=l*(1+.5*(Math.random()-.5));const i=$(t,n,e).x,a=$(t,n,e).y;x.beginPath(),x.moveTo(s,o),x.lineTo(i,a),x.stroke(),s=i,o=a}),i),x.lineWidth=l}async function E(t,n,i=""){event_popup.hidden=!1,event_popup_icon.hidden=null==t,null!=t&&(event_popup_icon.style.background=h[t]),event_popup_label.innerText=n,event_popup_description.innerText=i,await e.direct((e=>{event_popup_content.style.transform=`scale(${1.5-.5*e})`,event_popup.style.opacity=e}),300),await e.sleep(800),await e.direct((e=>{event_popup_content.style.transform=`scale(${1+.5*e})`,event_popup.style.opacity=1-e}),300),event_popup.hidden=!0}function T(e){let t;return t=e.y%2==0?[{x:e.x-1,y:e.y},{x:e.x+1,y:e.y}]:[{x:e.x,y:e.y-1},{x:e.x,y:e.y+1}],t.map((e=>({x:e.x/2,y:e.y/2})))}function N(e,t){return{x:i+e*s,y:i+t*s}}function C(e){return{x:Math.floor(e.x),y:Math.floor(e.y)}}function P(e,t){return{x:e.x+(Math.random()-.5)*t*2,y:e.y+(Math.random()-.5)*t*2}}function $(e,t,n){return{x:z(e.x,t.x,n),y:z(e.y,t.y,n)}}function z(e,t,n){return e+(t-e)*n}!async function(){e.defaultEasing=e=>(1-Math.cos(e*Math.PI))/2,await async function(){function e(e){const t=new Image;return new Promise((n=>{t.onload=()=>n(t),t.src=e}))}o.background=await e("resources/background.png"),o.paper=await e("resources/paper.png")}(),await void(l.paper=x.createPattern(o.paper,"repeat")),title_wrapper.hidden=!1,loading_wrapper.hidden=!0,title_start.addEventListener("click",(()=>{const i=title_players_select.value,o=title_size_select.value;d=Number(i),r=Number(o.split("x")[0]),c=Number(o.split("x")[1]),async function(){title_start.style.pointerEvents="none",ranking_to_title.style.pointerEvents="",game_wrapper.hidden=!1,a=new t(2*r+1,2*c+1,d),h=function(){const e=[];for(let t=0;t<d;t++){const n=`lch(60% 60% ${t/d*360}deg)`;e.push(n)}return e}(),y=0,function(){_=r*s+240,p=c*s+240,n.width=_,n.height=p,x=n.getContext("2d"),x.lineCap="round",m(),window.addEventListener("resize",m),n.addEventListener("click",b),x.strokeStyle="#aaaaaa",x.lineWidth=6,x.setLineDash([6,16]);for(let e=0;e<r+1;e++){const t=N(e,0),n=N(e,c);x.beginPath(),x.moveTo(t.x,t.y),x.lineTo(n.x,n.y),x.stroke()}for(let e=0;e<c+1;e++){const t=N(0,e),n=N(r,e);x.beginPath(),x.moveTo(t.x,t.y),x.lineTo(n.x,n.y),x.stroke()}x.setLineDash([]),x.fillStyle="#333333";const e=10;for(let t=0;t<c+1;t++)for(let n=0;n<r+1;n++){const i=N(n,t);x.beginPath(),x.arc(i.x,i.y,e,0,2*Math.PI),x.fill()}}(),g(),title_wrapper.style.zIndex=1e7,await e.direct((e=>{title_wrapper.style.opacity=""+(1-e)}),500),title_wrapper.style.opacity=1,title_wrapper.style.zIndex=null,title_wrapper.hidden=!0,await E(null,"スタート！")}()})),ranking_to_title.addEventListener("click",(()=>{!async function(){ranking_to_title.pointerEvents="none",title_wrapper.hidden=!1,game_wrapper.style.zIndex=1e7,await e.direct((e=>{game_wrapper.style.opacity=""+(1-e)}),500),game_wrapper.style.opacity=1,game_wrapper.style.zIndex=null,game_wrapper.hidden=!0,ranking.hidden=!0,title_start.style.pointerEvents="",window.removeEventListener("resize",m),n.removeEventListener("click",b)}()}))}()})();