(()=>{"use strict";var e={2:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.s_to_num=t.int_str_to_s=t.num_to_s=t.big_int_to_s=t.int_to_s=t.s_to_big_int=t.s_to_int=void 0;let n="";for(let e=0;e<10;e++){const t=String.fromCharCode(48+e);n+=t}for(let e=0;e<26;e++){const t=String.fromCharCode(65+e);n+=t}for(let e=0;e<26;e++){const t=String.fromCharCode(97+e);n+=t}const o=n.length,s={};for(let e=0;e<o;e++){const t=n[e];s[t]=e}function i(e){let t=0,n=1;for(let i=e.length-1;i>=0;i--){const r=e[i];let c=s[r];c*=n,t+=c,n*=o}return t}function r(e){let t=BigInt(0),n=BigInt(1);const i=BigInt(o);for(let o=e.length-1;o>=0;o--){const r=e[o];let c=BigInt(s[r]);c*=n,t+=c,n*=i}return t}function c(e){if(0===e)return n[0];const t=[];for(;0!==e;){const s=e%o,i=n[s];t.push(i),e-=s,e/=o}return t.reverse().join("")}function a(e){const t=BigInt(0),s=BigInt(o);if(e===t)return n[0];const i=[];for(;e!==t;){const t=n[Number(e%s)];i.push(t),e/=s}return i.reverse().join("")}function d(e){return e.split("").reverse().join("")}function l(e){const t=+e;return t.toString()===e&&t+1!==t&&t-1!==t?c(t):":"+a(BigInt(e))}function h(e){return":"===e[0]?r(e.substring(1)).toString():i(e).toString()}t.s_to_int=i,t.s_to_big_int=r,t.int_to_s=c,t.big_int_to_s=a,t.num_to_s=function e(t){if(t<0)return"-"+e(-t);let n,[o,s]=t.toString().split(".");if(!s){if(!o.includes("e"))return c(t);{const[e,t]=o.split("e");o=e,s="0e"+t}}s&&([s,n]=s.split("e")),o=l(o),s=d(s),s=l(s);let i=o+"."+s;if(n){switch(i+=".",n[0]){case"+":n=n.slice(1);break;case"-":i+="-",n=n.slice(1)}n=l(n),i+=n}return i},t.int_str_to_s=l,t.s_to_num=function e(t){if("-"===t[0])return-e(t.substr(1));let[n,o,s]=t.split(".");if(!o)return i(n);n=h(n),o=h(o),o=d(o);let r=n+"."+o;if(s){r+="e";let e=!1;"-"===s[0]&&(e=!0,s=s.slice(1)),s=h(s),r+=e?-s:+s}return+r}},148:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.decompress=t.decode=t.compress=void 0;const o=n(932),s=n(533),i=n(656);function r(e,t){if(""===t||"_"===t)return null;const n=e[(0,s.decodeKey)(t)];if(null===n)return n;switch(typeof n){case"undefined":case"number":return n;case"string":switch(n[0]+n[1]){case"b|":return(0,s.decodeBool)(n);case"o|":return function(e,t){if("o|"===t)return{};const n={},o=t.split("|");let s=r(e,o[1]);const i=o.length;i-2!=1||Array.isArray(s)||(s=[s]);for(let t=2;t<i;t++){const i=s[t-2];let c=o[t];c=r(e,c),n[i]=c}return n}(e,n);case"n|":return(0,s.decodeNum)(n);case"a|":return function(e,t){if("a|"===t)return[];const n=t.split("|"),o=n.length-1,s=new Array(o);for(let t=0;t<o;t++){let o=n[t+1];o=r(e,o),s[t]=o}return s}(e,n);default:return(0,s.decodeStr)(n)}}return(0,o.throwUnknownDataType)(n)}t.compress=function(e){const t=(0,i.makeInMemoryMemory)(),n=(0,i.addValue)(t,e,void 0);return[(0,i.memToValues)(t),n]},t.decode=r,t.decompress=function(e){const[t,n]=e;return r(t,n)}},243:(e,t,n)=>{t.mF=t.Bc=void 0;var o=n(148);Object.defineProperty(t,"Bc",{enumerable:!0,get:function(){return o.compress}}),Object.defineProperty(t,"mF",{enumerable:!0,get:function(){return o.decompress}});var s=n(148);var i=n(656);var r=n(290);var c=n(897)},290:(e,t)=>{function n(e,t){t.add(e);for(const o in e)if(void 0===e[o])delete e[o];else{const s=e[o];s&&"object"==typeof s&&!t.has(s)&&n(s,t)}}Object.defineProperty(t,"__esModule",{value:!0}),t.trimUndefinedRecursively=t.trimUndefined=void 0,t.trimUndefined=function(e){for(const t in e)void 0===e[t]&&delete e[t]},t.trimUndefinedRecursively=function(e){n(e,new Set)}},533:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.decodeStr=t.encodeStr=t.decodeBool=t.encodeBool=t.decodeKey=t.decodeNum=t.encodeNum=void 0;const o=n(2);t.encodeNum=function(e){return"n|"+(0,o.num_to_s)(e)},t.decodeNum=function(e){return e=e.replace("n|",""),(0,o.s_to_num)(e)},t.decodeKey=function(e){return"number"==typeof e?e:(0,o.s_to_int)(e)},t.encodeBool=function(e){return e?"b|T":"b|F"},t.decodeBool=function(e){switch(e){case"b|T":return!0;case"b|F":return!1}return!!e},t.encodeStr=function(e){switch(e[0]+e[1]){case"b|":case"o|":case"n|":case"a|":case"s|":e="s|"+e}return e},t.decodeStr=function(e){return"s|"===e[0]+e[1]?e.substr(2):e}},656:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.addValue=t.makeInMemoryMemory=t.makeInMemoryCache=t.makeInMemoryStore=t.memToValues=void 0;const o=n(897),s=n(932),i=n(533),r=n(2);function c(){const e=[];return{forEach(t){for(let n=0;n<e.length;n++)if("break"===t(e[n]))return},add(t){e.push(t)},toArray:()=>e}}function a(){const e=Object.create(null),t=Object.create(null);return{getValue:t=>e[t],getSchema:e=>t[e],forEachValue(t){for(const[n,o]of Object.entries(e))if("break"===t(n,o))return},forEachSchema(e){for(const[n,o]of Object.entries(t))if("break"===e(n,o))return},setValue(t,n){e[t]=n},setSchema(e,n){t[e]=n},hasValue:t=>t in e,hasSchema:e=>e in t}}function d(e,t){if(e.cache.hasValue(t))return e.cache.getValue(t);const n=e.keyCount++,o=(0,r.num_to_s)(n);return e.store.add(t),e.cache.setValue(t,o),o}function l(e,t,n){if(null===t)return"";switch(typeof t){case"undefined":if(Array.isArray(n))return l(e,null,n);break;case"object":if(null===t)return d(e,null);if(Array.isArray(t)){let n="a";for(let o=0;o<t.length;o++){const s=t[o];n+="|"+(null===s?"_":l(e,s,t))}return"a"===n&&(n="a|"),d(e,n)}{const n=Object.keys(t);if(0===n.length)return d(e,"o|");let s="o";const i=function(e,t){o.config.sort_key&&t.sort();const n=t.join(",");if(e.cache.hasSchema(n))return e.cache.getSchema(n);const s=l(e,t,void 0);return e.cache.setSchema(n,s),s}(e,n);s+="|"+i;for(const o of n){s+="|"+l(e,t[o],t)}return d(e,s)}case"boolean":return d(e,(0,i.encodeBool)(t));case"number":return Number.isNaN(t)?(o.config.error_on_nan&&(0,s.throwUnsupportedData)("[number NaN]"),""):Number.POSITIVE_INFINITY===t||Number.NEGATIVE_INFINITY===t?(o.config.error_on_infinite&&(0,s.throwUnsupportedData)("[number Infinity]"),""):d(e,(0,i.encodeNum)(t));case"string":return d(e,(0,i.encodeStr)(t))}return(0,s.throwUnknownDataType)(t)}t.memToValues=function(e){return e.store.toArray()},t.makeInMemoryStore=c,t.makeInMemoryCache=a,t.makeInMemoryMemory=function(){return{store:c(),cache:a(),keyCount:0}},t.addValue=l},897:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.config=void 0,t.config={sort_key:!1,error_on_nan:!1,error_on_infinite:!1}},932:(e,t)=>{function n(e){return Object.prototype.toString.call(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.throwUnsupportedData=t.throwUnknownDataType=t.getType=void 0,t.getType=n,t.throwUnknownDataType=function(e){throw new TypeError("unsupported data type: "+n(e))},t.throwUnsupportedData=function(e){throw new TypeError("unsupported data type: "+e)}}},t={};class n{constructor(e={}){const t=document.createElement("dialog");t.className="dialog","error"==e.type&&(t.style.borderColor="var(--error-color)"),"warning"==e.type&&(t.style.borderColor="var(--warning-color)"),"info"==e.type&&(t.style.borderColor="var(--info-color)");const n=document.createElement("div");n.className="dialog-content",t.appendChild(n);const o=document.createElement("div");o.className="dialog-footer",t.appendChild(o),this.dialog=t,this.content=n,this.footer=o,document.body.appendChild(t)}show_modal(){this.dialog.showModal()}close(){this.dialog.close(),document.body.removeChild(this.dialog)}static alert(e,t,n){const o=new DS(n);if(t){const e=document.createElement("p");e.innerText=t,e.className="dialog-title",o.content.appendChild(e)}const s=document.createElement("div");s.innerText=e,o.content.appendChild(s);const i=document.createElement("button");return i.innerText="OK",o.footer.appendChild(i),o.show_modal(),new Promise((e=>{i.addEventListener("click",(()=>{o.close(),e()}))}))}static confirm(e,t,n,o){const s=new DS,i=document.createElement("p");if(i.innerText=e,i.className="dialog-title",s.content.appendChild(i),t){const e=document.createElement("div");e.innerText=t,s.content.appendChild(e)}const r=document.createElement("button");r.innerText=n||"OK",s.footer.appendChild(r);const c=document.createElement("button");return c.innerText=o||"キャンセル",s.footer.appendChild(c),s.show_modal(),new Promise((e=>{r.addEventListener("click",(()=>{s.close(),e(!0)})),c.addEventListener("click",(()=>{s.close(),e(!1)}))}))}static version(e,t="0.0.0"){const n=new DS,o=document.createElement("p");o.innerText=e,o.className="dialog-title",n.content.appendChild(o);const s=document.createElement("span");s.innerText="現在のバージョン: ",n.content.appendChild(s);const i=document.createElement("code");i.innerText="v"+t,n.content.appendChild(i);const r=document.createElement("div");function c(e){e.addEventListener("blur",(()=>{let t=e.value;t.match(/^[0-9]+$/)||(t=t.replace(/[^0-9]/g,""),0==t.length&&(t="0")),e.value=t}))}r.className="version-selector",n.content.appendChild(r);const a=document.createElement("span");a.innerText="v",r.appendChild(a);const d=document.createElement("input");d.type="text",c(d),d.value=t.split(".")[0],r.appendChild(d);const l=document.createElement("span");l.innerText=".",r.appendChild(l);const h=document.createElement("input");h.type="text",c(h),h.value=t.split(".")[1],r.appendChild(h);const u=document.createElement("span");u.innerText=".",r.appendChild(u);const m=document.createElement("input");m.type="text",c(m),m.value=t.split(".")[2],r.appendChild(m);const p=document.createElement("button");p.innerText="OK",n.footer.appendChild(p);const g=document.createElement("button");return g.innerText="キャンセル",n.footer.appendChild(g),n.show_modal(),new Promise((e=>{p.addEventListener("click",(()=>{n.close(),e(`${d.value}.${h.value}.${m.value}`)})),g.addEventListener("click",(()=>{n.close(),e(null)}))}))}static prompt(e,t,n={}){const o=new DS,s=document.createElement("p");if(s.innerText=e,s.className="dialog-title",o.content.appendChild(s),t){const e=document.createElement("div");e.innerText=t,o.content.appendChild(e)}let i;if("bigtext"==n.type?(i=document.createElement("textarea"),i.wrap="soft",i.spellcheck=!1,i.placeholder="ここに直接入力"):(i=document.createElement("input"),i.type="text",i.spellcheck=!1),"bigtext"==n.type){const e=document.createElement("button");e.style.display="flex",e.style.alignItems="center",e.innerHTML='<span style="font: var(--icon-font-size) var(--icon-font)">content_paste_go</span>クリップボードから貼り付け',e.addEventListener("click",(async()=>{i.value=await navigator.clipboard.readText()})),o.content.appendChild(e)}o.content.appendChild(i);const r=document.createElement("button");r.innerText="OK",o.footer.appendChild(r);const c=document.createElement("button");function a(){i.value=i.value.replace(/[\\/:\*?"<>|]/,""),r.hidden=0==i.value.length}return c.innerText="キャンセル",o.footer.appendChild(c),i.value=n.value||"","folder"!=n.type&&"file"!=n.type||(i.addEventListener("input",a),i.addEventListener("paste",a),a()),o.show_modal(),new Promise((e=>{r.addEventListener("click",(()=>{o.close(),e(i.value)})),c.addEventListener("click",(()=>{o.close(),e(null)}))}))}static dropdown(e,t){const n=e.getBoundingClientRect(),o=n.left,s=n.bottom,i=document.createElement("div");i.className="dropdown";const r=document.createElement("div");r.className="dropdown-back";const c=()=>{a()};function a(){document.body.removeChild(i),document.body.removeChild(r),document.removeEventListener("resize",c)}return document.body.appendChild(r),document.body.appendChild(i),document.addEventListener("resize",c),new Promise((e=>{r.addEventListener("click",(()=>{a(),e(-1)}));for(let n=0;n<t.length;n++){const o=t[n],s=document.createElement("div");s.innerText=o,i.appendChild(s),s.addEventListener("click",(t=>{t.stopPropagation(),a(),e(n)}))}const n=getComputedStyle(i),c=Number.parseInt(n.width),d=Number.parseInt(n.height);i.style.left=(o+c+30>innerWidth?innerWidth-c-30:o)+"px",i.style.top=(s+d+30>innerHeight?innerHeight-d-30:s)+"px"}))}}class o{#e=0;#t=0;#n=0;#o=0;#s=[];constructor(e,t,n,o){this.x=e,this.y=t,this.width=n,this.height=o}get x(){return this.#e}set x(e){this.#e=e,this.onchange()}get y(){return this.#t}set y(e){this.#t=e,this.onchange()}get width(){return this.#n}set width(e){this.#n=e,this.onchange()}get height(){return this.#o}set height(e){this.#o=e,this.onchange()}get left(){return this.x}get right(){return this.x+this.width}get centerX(){return(this.left+this.right)/2}get top(){return this.y}get bottom(){return this.y+this.height}get centerY(){return(this.top+this.bottom)/2}hitPoint(e,t){const n=this.left<=e&&e<this.right,o=this.top<=t&&t<this.bottom;return n&&o}addEventListener(e,t){this.#s.push(t)}removeEventListener(e,t){this.#s.splice(this.#s.indexOf(t),1)}onchange(){for(const e of this.#s)e()}getRelativeOf(e,t){return{x:(e-this.centerX)/this.width*2,y:(t-this.centerY)/this.height*2}}getPositionByRelative(e){return{x:this.centerX+this.width*e.x/2,y:this.centerY+this.height*e.y/2}}clone(){return new o(this.x,this.y,this.width,this.height)}}class s{static exportToImage(e,t,n,o={}){const s=o.scale||4,i=this.exportToSvg(e,o);t||(t=Math.ceil(i.getAttribute("width")*s),n=Math.ceil(i.getAttribute("height")*s));const r=document.createElement("canvas");r.width=t,r.height=n;const c=r.getContext("2d"),a=new Image;return new Promise((e=>{a.onload=()=>{c.fillStyle="white",c.fillRect(0,0,t,n),c.drawImage(a,0,0,t,n),e(r)},a.src=this.svgToUrl(i)}))}static exportToSvg(e,t){const n=this.getRectOfGroup(e),o=n.x,s=n.y,i=10,r=i+n.width+i,c=i+n.height+i,a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("width",r.toString()),a.setAttribute("height",c.toString()),a.setAttribute("viewBox",`-10 -10 ${r} ${c}`);const d=Snap(a);for(const t of e.dom.children)t.isNode?this.drawNodeSvg(d,t.fElement,o,s):this.drawConnectorSvg(d,t.fElement,o,s);return a}static drawNodeSvg(e,t,n,o){const s=t.cssRect;if(e.image(this.svgToUrl(t.domSvg),s.x-n,s.y-o,s.width,s.height),!t.domMath)return;const i=t.domMath.getBoundingClientRect(),r=s.centerX-i.width/2-n,c=s.centerY-i.height/2-o;e.image(this.svgToUrl(t.domMath.children[0]),r,c,i.width,i.height)}static drawConnectorSvg(e,t,n,o){const s=t.domSvg,i=Number.parseFloat(s.style.left),r=Number.parseFloat(s.style.top),c=Number.parseFloat(s.getAttribute("width")),a=Number.parseFloat(s.getAttribute("height"));e.image(this.svgToUrl(s),i-n,r-o,c,a)}static getRectOfGroup(e){let t=1/0,n=1/0,s=-1/0,i=-1/0;for(const o of e.nodes)t=Math.min(t,o.cssRect.left),n=Math.min(n,o.cssRect.top),s=Math.max(s,o.cssRect.right),i=Math.max(i,o.cssRect.bottom);for(const o of e.connectors)for(const e of o.segments)t=Math.min(t,e.start.cssX,e.end.cssX),n=Math.min(n,e.start.cssY,e.end.cssY),s=Math.max(s,e.start.cssX,e.end.cssX),i=Math.max(i,e.start.cssY,e.end.cssY);return new o(t,n,s-t,i-n)}static svgToUrl(e){let t=(new XMLSerializer).serializeToString(e);t=t.replace(/<desc>.*<\/desc>/,"");const n=unescape(encodeURIComponent(t));return"data:image/svg+xml;base64,"+window.btoa(n)}}class i{enabledChecker=()=>!0;clampArea=!1;#i={};#r={};#c=0;get viewX(){return this.#c}set viewX(e){if(isNaN(e))throw new Error("NaN!NaN!");this.#c=e}viewY=0;viewScale=1;targetRect=null;#a=null;#d=0;#l=0;touchesCount=0;pointers=1;onchange=()=>{};constructor(e){if(!(e instanceof HTMLElement))throw new Error("Illegal FlexiBox constructor argument; Invalid dom element");this.#a=e,this.#a.addEventListener("pointerdown",(e=>{this.enabledChecker()&&this.onpointerdown(e)})),this.#a.addEventListener("pointermove",(e=>{this.enabledChecker()&&this.onpointermove(e)})),this.#a.addEventListener("pointerup",(e=>{this.enabledChecker()&&this.onpointerup(e)})),this.#a.addEventListener("mousedown",(e=>{this.pointers=1})),this.#a.addEventListener("wheel",(e=>{this.enabledChecker()&&(this.onwheel(e),e.preventDefault())})),this.#a.addEventListener("touchstart",(e=>{this.pointers=e.touches.length,this.enabledChecker()&&this.ontouchstart(Array.from(e.touches))})),this.#a.addEventListener("touchmove",(e=>{this.enabledChecker()&&(this.ontouchmove(Array.from(e.touches)),e.preventDefault())})),this.#a.addEventListener("touchend",(e=>{this.pointers=e.touches.length,0==this.pointers&&(this.#i={},this.#r={}),this.enabledChecker()&&this.ontouchend(Array.from(e.touches))}))}get viewRect(){const e=this.viewX,t=this.viewY,n=this.#h(),s=n.width/this.viewScale,i=n.height/this.viewScale;return new o(e,t,s,i)}onpointerdown(e){this.#i[e.pointerId]=e.x,this.#r[e.pointerId]=e.y}onpointermove(e){if(!this.#i[e.pointerId])return;const t=(e.x-this.#i[e.pointerId])/this.viewScale,n=(e.y-this.#r[e.pointerId])/this.viewScale;this.viewX-=t/this.pointers,this.viewY-=n/this.pointers,this.clampArea&&(this.viewX=this.#u(this.viewX,0,this.targetRect.width-this.viewRect.width),this.viewY=this.#u(this.viewY,0,this.targetRect.height-this.viewRect.height)),this.#i[e.pointerId]=e.x,this.#r[e.pointerId]=e.y,this.onchange()}onpointerup(e){delete this.#i[e.pointerId],delete this.#r[e.pointerId]}onwheel(e){if(e.ctrlKey){const t=1-.1*Math.sign(e.deltaY),n=this.#a.getBoundingClientRect(),o=this.viewX+(e.x-n.left)/this.viewScale,s=this.viewY+(e.y-n.top)/this.viewScale;this.changeScale(t,o,s),this.onchange()}}ontouchstart(e){e.length>1&&(this.#l=this.#m(e)),this.#d=e.length,this.touchesCount=e.length}ontouchmove(e){const t=this.#d,n=e.length;if(this.#d=n,this.touchesCount=n,n==t){if(e.length>1){const t=(e[0].clientX+e[1].clientX)/2,n=(e[0].clientY+e[1].clientY)/2,o=t/this.viewScale,s=n/this.viewScale,i=this.viewX+o,r=this.viewY+s,c=this.#m(e),a=c/this.#l;return this.#l=c,this.changeScale(a,i,r),void this.onchange()}}else this.onchange()}ontouchend(e){this.touchesCount=e.length,this.onchange()}#m(e){const t=e[0].clientX-e[1].clientX,n=e[0].clientY-e[1].clientY;return Math.sqrt(t**2+n**2)}changeScale(e,t,n){const o=this.viewX-t,s=this.viewY-n,i=this.viewScale;this.viewScale*=e,this.viewScale=Math.max(this.viewScale,.25),this.viewScale=Math.min(this.viewScale,10),this.viewX=t+o/(this.viewScale/i),this.viewY=n+s/(this.viewScale/i),this.clampArea&&(this.viewX=this.#u(this.viewX,0,this.targetRect.width-this.viewRect.width),this.viewY=this.#u(this.viewY,0,this.targetRect.height-this.viewRect.height))}#h(){const e=this.#a.getBoundingClientRect();return new o(e.left,e.top,e.width,e.height)}#u(e,t,n){return Math.min(Math.max(e,t),n)}}const r=class{static get group(){return this.flowchart.group}static get flexibox(){return this.group.flexibox}static selected=null;static gridEnabled=!0},c=Snap;class a{static generateNodeSvg(e,t,n,o={}){const s=t-2,i=n-2,r=o.unit||15,a=this.createSvg();a.setAttribute("width",t.toString()),a.setAttribute("height",n.toString()),a.setAttribute("viewBox",`-1 -1 ${t} ${n}`);const d=c(a);let l;switch(e){case"rect":l=d.rect(0,0,s,i);break;case"subroutine":{const e=d.rect(0,0,s,i),t=d.line(r,0,r,i),n=d.line(s-r,0,s-r,i);l=d.group(e,t,n);break}case"loopstart":l=d.polygon(r,0,s-r,0,s,r,s,i,0,i,0,r);break;case"loopend":l=d.polygon(0,0,s,0,s,i-r,s-r,i,r,i,0,i-r);break;case"switch":{const e=Math.min(s,i)/2,t=[];t.push(0,e,e,0),t.push(s-e,0,s,e),t.push(s,i-e,s-e,i),t.push(e,i,0,i-e),l=d.polygon(t);break}case"database":{const e=s/2,t=s/2,n=.15*i,o=d.rect(e-t,0,2*t,i);o.attr({clipPath:d.rect(-1+e-t,n,2+2*t,i-2*n)});const r=d.ellipse(e,n,t,n),c=d.ellipse(e,i-n,t,n);l=d.group(c,o,r);break}case"connect":{const e=Math.min(s,i),o=(Math.max(s,i),e/2),r=o,c=o;let a,h;s>i?(a=s-o,h=o):(a=o,h=i-o);Math.min(t,n),Math.max(t,n);const u=d.ellipse(r,c,o,o),m=d.rect(0,0,s,i),p=d.ellipse(a,h,o,o);s>i?(u.attr({clipPath:d.rect(-1,-1,1+o,n)}),m.attr({clipPath:d.rect(o,-1,s-2*o,n)}),p.attr({clipPath:d.rect(s-o,-1,o+1,n)})):(u.attr({clipPath:d.rect(-1,-1,t,1+o)}),m.attr({clipPath:d.rect(-1,o,t,i-2*o)}),p.attr({clipPath:d.rect(-1,i-o,t,o+1)})),l=d.group(u,m,p);break}case"io":l=d.polygon(1.5*r,0,s,0,s-1.5*r,i,0,i)}l.attr({fill:o.fill||"white",stroke:o.stroke||"black",strokeWidth:o.strokeWidth||1.5});const h=o.text;if(h){const e=h.split("\n");for(let t=0;t<e.length;t++){const n=e[t],o=t-e.length/2+.5;d.text(s/2,i/2+20*o,n).attr({fontSize:"14px",fill:"black",textAnchor:"middle",dominantBaseline:"central",fontFamily:"sans-serif"})}}return a}static generateConnectorSvg(e){const t=e.segments||[],n=e.strokeWidth||2;e.start&&e.end&&t.push({start:e.start,end:e.end});const o=this.createSvg();if(0==t.length)return o;const s=c(o);let i=1/0,r=1/0,a=-1/0,d=-1/0;const l=[];for(let n=0;n<t.length;n++){const o=t[n];if(o.start.x==o.end.x&&o.start.y==o.end.y){l.push(null);continue}let s=o.start.x,c=o.start.y,h=o.end.x,u=o.end.y,m=h-s,p=u-c;i=Math.min(i,s,h),r=Math.min(r,c,u),a=Math.max(a,s,h),d=Math.max(d,c,u);const g=1-5/Math.sqrt(m**2+p**2);let f=s,v=c,w=h,x=u;e.startHead&&0==n&&(f=h-m*g,v=u-p*g),e.endHead&&n==t.length-1&&(w=s+m*g,x=c+p*g),l.push([f,v,w,x])}for(let o=0;o<t.length;o++){if(!l[o])continue;const i=t[o].stroke||e.color||"black",r=l[o][0],c=l[o][1],a=l[o][2],d=l[o][3];0<=o&&o<t.length&&s.ellipse(a,d,n/2,n/2).attr({fill:i}),s.line(r,c,a,d).attr({stroke:i,strokeWidth:n,strokeLinejoin:"round",strokeDasharray:e.dasharray||null}),s.line(r,c,a,d).attr({stroke:"transparent",strokeWidth:10,strokeLinejoin:"round",pointerEvents:"visibleStroke"})}s.attr({pointerEvents:"none"});const h=i-5,u=r-5,m=a-i+10,p=d-r+10;e.disablePosition||(o.style.left=`${h}px`,o.style.top=`${u}px`),o.setAttribute("width",m.toString()),o.setAttribute("height",p.toString()),o.setAttribute("viewBox",`${i-5} ${r-5} ${m} ${p}`);const g=(t,n)=>{const o=t==n.end?1:-1,i=(n.end.x-n.start.x)*o,r=(n.end.y-n.start.y)*o,c=Math.atan2(r,i)*(180/Math.PI),a=t.x,d=t.y,l=s.polygon(a,d,a-8,d-5,a-5,d,a-8,d+5);l.attr({fill:e.color||"black",pointerEvents:"visibleFill"}),l.transform(`r${c},${a},${d}`)},f=t[0],v=t[t.length-1];return e.startHead&&g(f.start,f),e.endHead&&g(v.end,v),o}static createSvg(){return document.createElementNS("http://www.w3.org/2000/svg","svg")}}class d{locked=!1;get cssX(){return this.x*r.flowchart.scale/devicePixelRatio}get cssY(){return this.y*r.flowchart.scale/devicePixelRatio}}class l extends d{node=null;nodeConnectedRelative={x:0,y:0};locked=!0;constructor(e,t){super(),this.node=e,this.nodeConnectedRelative=t}get x(){return(this.node?.rect.getPositionByRelative(this.nodeConnectedRelative)||{x:0,y:0}).x}get y(){return(this.node?.rect.getPositionByRelative(this.nodeConnectedRelative)||{x:0,y:0}).y}get relative(){return this.nodeConnectedRelative}}class h extends d{locked=!1;x=0;y=0;constructor(e,t){super(),this.x=e,this.y=t}}class u{start=null;end=null;stroke=null;constructor(e,t){this.start=e,this.end=t}get isHorizontal(){return this.start.y==this.end.y}get isVertical(){return!this.isHorizontal}}class m{scale;dom;domControl;toSnapped(e){return 5*Math.round(e/5)}cssToDataCoordinate(e){return e/this.scale*devicePixelRatio}toDataCoordinate(e){return e/this.scale*devicePixelRatio/this.group.flexibox.viewScale}toCSSCoordinate(e){return e*this.scale/devicePixelRatio}getFrameRect(){return r.flowchart.frame.getBoundingClientRect()}}class p extends m{scale=1;dom=null;domSvg=null;domControl=null;segments=[];updateListener=null;group=null;selectedSegment=null;selectedPoint=null;color="#000000";lineWeight="normal";dash=!1;startHead=!1;endHead=!0;constructor(e=[]){super(),this.dom=document.createElement("div"),this.dom.fElement=this,this.dom.setAttribute("class","flowchart-connector"),this.domSvg=document.createElement("svg"),this.dom.appendChild(this.domSvg),this.segments=e,this.createDomControl(),this.attachSelectEvents(),this.updateDom();const t=this;this.updateListener=()=>{t.updateDom()},this.dom.addEventListener("pointerdown",(e=>{this.onclick(),e.preventDefault()}))}attachSelectEvents(){this.dom.addEventListener("pointerdown",(e=>{const t=this.toDataCoordinate(e.x-this.getFrameRect().left),n=this.toDataCoordinate(e.y-this.getFrameRect().top);let o=null,s=1/0;const i=(e,t)=>Math.atan2(e.y-t.y,e.x-t.x);for(const e of this.segments){const r=i(e.start,{x:t,y:n}),c=i({x:t,y:n},e.end);let a=Math.abs(c-r);a>Math.PI&&(a=2*Math.PI-a),a<s&&(s=a,o=e),e.stroke=""}const r=(e,t)=>Math.abs(e.x-t.x)+Math.abs(e.y-t.y),c=r(o.start,{x:t,y:n})<r({x:t,y:n},o.end)?o.start:o.end;this.selectedPoint=c,o.stroke="var(--selected-color)",this.selectedSegment=o,this.updateDom()}))}createDomControl(){const e=null==this.domControl||this.domControl.hidden;this.dom.contains(this.domControl)&&this.dom.removeChild(this.domControl),this.domControl=document.createElement("div"),this.domControl.hidden=e,this.domControl.className="flowchart-connector-control";const t=[];for(const e of this.segments)t.includes(e.start)||t.push(e.start),t.includes(e.end)||t.push(e.end);for(const e of t)this.createDraggable(t,e);this.dom.appendChild(this.domControl)}createDraggable(e,t){const n=this.segments.find((e=>e.start==t||e.end==t)),o=t==this.selectedPoint,s=document.createElement("div");let i,c,a,d,u;s.point=t,s.className="flowchart-connector-grab",s.className+=o?" flowchart-connector-grab-selected":"",s.style.left=`${this.toCSSCoordinate(t.x)}px`,s.style.top=`${this.toCSSCoordinate(t.y)}px`,this.domControl.appendChild(s);const m=e.indexOf(t),p=0==m,g=m==e.length-1,f=p||g,w=()=>this.updateDom();t instanceof v.NodeEdgeSegmentPoint&&(u={node:t.node,relative:t.relative},u.node&&u.node.rect.addEventListener("change",w));const x=(e,t)=>{for(const n of this.group.nodes)if(n.rect.hitPoint(e,t)){const o=n.rect.getRelativeOf(e,t);return o.x=Math.round(o.x),o.y=Math.round(o.y),0==o.x&&0==o.y&&(o.y=1),{node:n,relative:o}}},y=e=>{const t=new l(e.node,e.relative);n.start==s.point?n.start=t:n.end=t,this.selectedPoint==s.point&&(this.selectedPoint=t),s.point=t,e.node.rect.addEventListener("change",w)},C=()=>{const e=new h(i+a,c+d);n.start==s.point?n.start=e:n.end=e,this.selectedPoint==s.point&&(this.selectedPoint=e),s.point=e,u.node.rect.removeEventListener("change",w)},b=e=>{const t=s.point instanceof h;if(a+=this.toDataCoordinate(e.movementX),d+=this.toDataCoordinate(e.movementY),t&&(s.point.x=i+a,s.point.y=c+d),f){const e=x(i+a,c+d);e&&t?(s.point.x=e.node.rect.getPositionByRelative(e.relative).x,s.point.y=e.node.rect.getPositionByRelative(e.relative).y,u=e):t?u=null:(C(),u=null,this.updateDom())}r.flowchart.snap&&(s.point.x=this.toSnapped(s.point.x),s.point.y=this.toSnapped(s.point.y)),this.updateDom()},E=()=>{document.removeEventListener("pointermove",b),document.removeEventListener("pointerup",E),u&&(y(u),this.updateDom())};s.addEventListener("pointerdown",(e=>{i=s.point.x,c=s.point.y,a=0,d=0,document.addEventListener("pointermove",b),document.addEventListener("pointerup",E)}))}updateDomControl(){for(const e of this.domControl.children){const t=e.point;e.style.left=`${this.toCSSCoordinate(t.x)}px`,e.style.top=`${this.toCSSCoordinate(t.y)}px`;const n=t==this.selectedPoint;e.className="flowchart-connector-grab",e.className+=n?" flowchart-connector-grab-selected":"",e.className+=t instanceof l?" flowchart-connector-grab-snap":""}}onclick(){this.group.selected!=this&&(this.group.selected&&this.group.selected.unselect(),this.select())}select(){this.domControl.hidden=!1,this.group.select(this)}unselect(){this.group.selected=null,this.dom.className="flowchart-connector",this.domControl.hidden=!0;for(const e of this.segments)e.stroke="";this.updateDom(),this.group.select(null)}addSegment(e){this.segments.push(e),e.start.addEventListener("change",updateListener),e.end.addEventListener("change",updateListener),this.createDomControl()}removeSegment(e){this.segments.splice(this.segments.indexOf(e),1),e.start.removeEventListener("change",updateListener),e.end.removeEventListener("change",updateListener),this.createDomControl()}setLineWeight(e){this.lineWeight=e,this.updateDom()}setDash(e){this.dash=e,this.updateDom()}setStartHead(e){this.startHead=e,this.updateDom()}setEndHead(e){this.endHead=e,this.updateDom()}addPoint(){const e=this.selectedSegment||this.segments[0];if(!e)return;const t=(e.start.x+e.end.x)/2,n=(e.start.y+e.end.y)/2,o=new h(t,n),s=new u(e.start,o),i=new u(o,e.end);this.segments.splice(this.segments.indexOf(e),1,s,i),s.stroke="var(--selected-color)",this.selectedSegment=s,this.selectedPoint=o,this.createDomControl(),this.updateDom()}deletePoint(){const e=this.selectedPoint;if(!e)return;const t=this.segments.filter((t=>t.start==e||t.end==e));if(1==t.length)this.segments.splice(this.segments.indexOf(t[0]),1),this.selectedPoint=null,this.segments.length>0?this.selectedPoint=this.segments[0].start:(this.unselect(),this.group.deleteConnector(this));else{const e=t[0].start,n=t[1].end,o=new u(e,n);this.segments.splice(this.segments.indexOf(t[0]),2,o),this.selectedPoint=e}this.createDomControl(),this.updateDom()}reverse(){this.segments.reverse();for(const e of this.segments)[e.start,e.end]=[e.end,e.start];this.updateDom()}updateDom(){const e=this.segments.map((e=>({start:{x:this.toCSSCoordinate(e.start.x),y:this.toCSSCoordinate(e.start.y)},end:{x:this.toCSSCoordinate(e.end.x),y:this.toCSSCoordinate(e.end.y)},stroke:e.stroke}))),t=a.generateConnectorSvg({segments:e,strokeWidth:"normal"==this.lineWeight?1.5:3,dasharray:this.dash?[4,4]:null,startHead:this.startHead,endHead:this.endHead,color:this.color});this.domSvg.replaceWith(t),this.domSvg=t,this.updateDomControl()}}class g extends m{rect;nexts=[];scale=1;shape="rectangle";dom=null;domSvg=null;domText=null;domMath=null;domEditable=null;domControl=null;draggables=[];connectors=[];value="";controlling=!1;group=null;selected=!1;isSelectedPropagation=!1;stroke="#000000";background="#ffffff";constructor(e={}){super(),e.shape&&(this.shape=e.shape),this.rect=new o(0,0,120,30),this.rect.addEventListener("change",(()=>this.updateDom())),this.dom=document.createElement("div"),this.dom.fElement=this,this.dom.isNode=!0,this.dom.className="flowchart-node",this.domSvg=document.createElement("svg"),this.dom.appendChild(this.domSvg),this.domText=document.createElement("div"),this.domText.className="flowchart-node-text",this.dom.appendChild(this.domText),this.domEditable=document.createElement("div"),this.domEditable.className="flowchart-node-editable",this.domEditable.contentEditable=!0,this.domEditable.hidden=!0,this.dom.appendChild(this.domEditable),this.updateDom(),this.domControl=document.createElement("div"),this.domControl.className="flowchart-node-control",this.domControl.hidden=!0,this.createControl(),this.dom.appendChild(this.domControl),this.dom.addEventListener("pointerdown",(e=>{this.isSelectedPropagation=!this.selected,this.onclick()})),this.dom.addEventListener("pointerup",(()=>{})),this.attachMoveEvents(),this.attachTextEvents()}get cssRect(){const e=this.rect,t=this.toCSSCoordinate(e.x),n=this.toCSSCoordinate(e.y),s=this.toCSSCoordinate(e.width),i=this.toCSSCoordinate(e.height);return new o(t,n,s,i)}attachMoveEvents(){let e,t,n,o;const s=s=>{this.controlling||document.activeElement!=this.domText&&(n+=this.toDataCoordinate(s.movementX),o+=this.toDataCoordinate(s.movementY),this.rect.x=e+n,this.rect.y=t+o,r.flowchart.snap&&this.snap(),this.updateDom())};this.dom.addEventListener("pointerdown",(i=>{e=this.rect.x,t=this.rect.y,n=0,o=0,document.addEventListener("pointermove",s)})),document.addEventListener("pointerup",(()=>{document.removeEventListener("pointermove",s)}))}attachTextEvents(){this.dom.addEventListener("pointerdown",(e=>{this.selected&&!this.isSelectedPropagation&&this.toEditable()})),this.domEditable.addEventListener("pointermove",(e=>{e.stopPropagation()})),this.domEditable.addEventListener("input",(()=>{const e=this.domEditable;e.style.color="="==e.innerHTML[0]?"purple":"unset"}))}createControl(){const e=document.createElement("div");e.className="flowchart-node-sizer";const t=()=>{this.domControl.appendChild(e),n()},n=()=>{const t=Math.round(10*this.rect.width)/10,n=Math.round(10*this.rect.height)/10;e.innerText=`${t} × ${n}`},o=()=>{this.domControl.removeChild(e)},s=[[1,0],[0,1],[-1,0],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]];for(const e of s){const s=document.createElement("div");let i,c,a;s.className="flowchart-node-grab",s.style.left=50*e[0]+50+"%",s.style.top=50*e[1]+50+"%",s.style.width=(e[0],"10px"),s.style.height=(e[1],"10px"),this.domControl.appendChild(s),this.draggables.push({x:e[0],y:e[1],dom:s});const d=t=>{c+=this.toDataCoordinate(t.movementX),a+=this.toDataCoordinate(t.movementY),this.rect.x=i.x+c*Number(-1==e[0]),this.rect.y=i.y+a*Number(-1==e[1]),this.rect.width=i.width+c*e[0],this.rect.height=i.height+a*e[1],r.flowchart.snap&&this.snap(),this.normalize(),n()},l=()=>{this.controlling=!1,document.removeEventListener("pointermove",d),document.removeEventListener("pointerup",l),r.flowchart.snap&&this.snap(),o()};s.addEventListener("pointerdown",(e=>{i=this.rect.clone(),c=0,a=0,t(),this.controlling=!0,document.addEventListener("pointermove",d),document.addEventListener("pointerup",l),e.stopPropagation()}))}}snap(){const e=this.rect.x,t=this.rect.y;this.rect.x=this.toSnapped(e),this.rect.y=this.toSnapped(t),this.rect.width=this.toSnapped(this.rect.width+e-this.rect.x),this.rect.height=this.toSnapped(this.rect.height+t-this.rect.y)}normalize(){this.rect.width<0&&([this.rect.x,this.rect.width]=[this.rect.x+this.rect.width,-this.rect.width]),this.rect.height<0&&([this.rect.y,this.rect.height]=[this.rect.y+this.rect.height,-this.rect.height])}async onclick(){this.selected||(this.group.selected&&await this.group.selected.unselect(),this.select())}select(){this.isSelectedPropagation=!0,this.selected=!0,this.dom.className="flowchart-node flowchart-node-selected",this.domControl.hidden=!1,this.group.select(this)}async unselect(){this.selected=!1,this.dom.className="flowchart-node",this.domControl.hidden=!0,this.group.select(null),this.domEditable.hidden||this.toUneditable(),await this.computeValue(),this.updateDom()}setValue(e){this.value=e,this.domEditable.innerText=e,this.updateDom(),this.computeValue()}toEditable(){this.domText.hidden=!0,this.domEditable.hidden=!1,this.domMath&&(this.dom.removeChild(this.domMath),this.domMath=null),this.updateDom(),setTimeout((()=>{this.domEditable.focus()}),0),this.domEditable.focus()}toUneditable(){this.value=this.domEditable.innerText,this.domText.hidden=!1,this.domEditable.hidden=!0,this.domMath&&(this.domMath.hidden=!1)}async computeValue(){this.domText.innerHTML="";const e=this.value;if(e.startsWith("=")){const t=e.substring(1,e.length),n=await this.createMathSvgAsync(t);if(n.innerHTML.includes("merror")){const[e]=n.innerHTML.match(/(?<=data-mjx-error=")[^"]+(?=")/),t=document.createElement("span");t.innerText=`数式エラー: ${e}`,t.style.color="red",this.domText.replaceChildren(t)}else this.dom.contains(this.domMath)?this.domMath.replaceWith(n):this.dom.appendChild(n),this.domMath=n}else this.dom.contains(this.domMath)&&this.dom.removeChild(this.domMath),this.domMath=null}async createMathSvgAsync(e){const t=`\\displaylines{${e}}`;try{return await MathJax.tex2svgPromise(t,{display:!0})}catch(e){alert(e.message)}}updateDom(){const e=Math.round(this.rect.x*this.scale/devicePixelRatio),t=Math.round(this.rect.y*this.scale/devicePixelRatio),n=Math.round(this.rect.width*this.scale/devicePixelRatio),o=Math.round(this.rect.height*this.scale/devicePixelRatio);this.dom.style.left=`${e}px`,this.dom.style.top=`${t}px`,this.dom.style.width=`${n}px`,this.dom.style.height=`${o}px`;const s=this.domMath?null:this.value,i=a.generateNodeSvg(this.shape,n,o,{stroke:this.stroke,fill:this.background,text:this.domEditable.hidden?s:null});this.domSvg.replaceWith(i),this.domSvg=i,this.domSvg.setAttribute("class","flowchart-node-shape")}}class f{frame=null;flexibox=null;selected=null;nodes=[];connectors=[];dom=null;onselectchange=()=>{};constructor(e){this.frame=e,this.flexibox=new i(flowchartArea),this.dom=document.createElement("div"),this.dom.className="flowchart-nodegroup",this.flexibox.enabledChecker=()=>!this.selected&&r.group==this}addNode(e){e.group=this,this.nodes.push(e),this.dom.appendChild(e.dom)}deleteNode(e){e.group=null,this.dom.removeChild(e.dom),this.nodes.splice(this.nodes.indexOf(e),1)}addConnector(e){e.group=this,this.connectors.push(e),this.dom.appendChild(e.dom)}deleteConnector(e){e.group=null,this.dom.removeChild(e.dom),this.connectors.splice(this.connectors.indexOf(e),1)}select(e){this.selected=e,this.onselectchange(e)}moveToFront(e){this.dom.removeChild(e.dom),this.dom.appendChild(e.dom)}moveToBack(e){this.dom.removeChild(e.dom),this.dom.insertBefore(e.dom,this.dom.firstChild)}repaint(){const e=this.flexibox.viewX,t=this.flexibox.viewY,n=this.flexibox.viewScale,o=e*n,s=t*n;this.frame.style.transform=`translate(${-o}px,${-s}px) scale(${n})`,footerScaleText.innerText=`${Math.round(100*n)}%`,footerXText.innerText=`${Math.round(o)}`,footerYText.innerText=`${Math.round(s)}`,this.repaintGrid(o,s,n)}repaintGrid(e,t,n){if(r.flowchart.gridEnabled){const o=10*r.flowchart.scale/window.devicePixelRatio;flowchartGrid.style.backgroundSize=`${o}px ${o}px`;const s=Math.floor(e/n/o)*o*n,i=Math.floor(t/n/o)*o*n,c=Number.parseFloat(getComputedStyle(flowchartArea).width),a=Number.parseFloat(getComputedStyle(flowchartArea).height),d=(Math.ceil(c/(o*n))+1)*o,l=(Math.ceil(a/(o*n))+1)*o;flowchartGrid.style.width=`${d}px`,flowchartGrid.style.height=`${l}px`,flowchartGrid.style.left=-(e-s)+"px",flowchartGrid.style.top=-(t-i)+"px",flowchartGrid.style.transform=`scale(${n})`,flowchartGrid.hidden=!1}else flowchartGrid.hidden=!0}}class v{static Connector=p;static Node=g;static FreeSegmentPoint=h;static NodeEdgeSegmentPoint=l;static Segment=u;frame=null;scale=4;groups=[];group=null;dom=null;snap=!0;gridEnabled=!0;onselectchange=()=>{};constructor(e){this.frame=e,this.dom=document.createElement("div"),this.dom.className="flowchart"}createNode(e){const t=new g(e);return t.scale=this.scale,t.updateDom(),t}createConnector(e){let t=e.segments;if(!t){const n=e.start,o=e.end,s=new h(n.x,n.y),i=new h(o.x,o.y);t=[new u(s,i)]}const n=new p(t);return n.scale=this.scale,n.updateDom(),n}createGroup(){return new f(this.frame)}addGroup(e){this.groups.push(e),e.onselectchange=e=>this.onselectchange(e)}deleteGroup(e){this.groups.splice(this.groups.indexOf(e),1),e.onselectchange=()=>{}}selectGroup(e){this.dom.replaceChildren(e.dom),this.group=e,e.flexibox.onchange=()=>e.repaint(),e.repaint(),this.onselectchange(e.selected)}}var w=function n(o){var s=t[o];if(void 0!==s)return s.exports;var i=t[o]={exports:{}};return e[o](i,i.exports,n),i.exports}(243);const x=(e,t=50)=>{for(var n=[],o=127;--o;)(48<=o&&57>=o||65<=o&&90>=o||97<=o&&122>=o||"-_.!~*'()".includes(String.fromCharCode(o)))&&n.push(String.fromCharCode(o));for(o=32;255>o;++o){var s=String.fromCharCode(o);"\\"==s||n.includes(s)||n.unshift(s)}e=e.replace(/\u0001/g,""),e=C(e),o=n.length,s="";for(var i={},r=2;r<t;r++)for(var c=0;c<e.length-r;++c){var a=e.substr(c,r);if(!i[a]){var d=a.charCodeAt(0),l=a.charCodeAt(a.length-1);if(!(56320<=d&&57343>=d||55296<=l&&56319>=l)){for(d=1,l=e.indexOf(a,c+r);0<=l;++d)l=e.indexOf(a,l+r);1<d&&(i[a]=d)}}}for(;;){for(;o--&&e.includes(n[o]););if(0>o)break;t=n[o];var h=void 0;for(var u in r=0,c=encodeURI(encodeURIComponent(t)).replace(/%../g,"i").length,i)a=((a=i[u])-1)*encodeURI(encodeURIComponent(u)).replace(/%../g,"i").length-(a+1)*c,s.length||(a-=encodeURI(encodeURIComponent("")).replace(/%../g,"i").length),0>=a?delete i[u]:a>r&&(h=u,r=a);if(!h)break;for(var u in e=e.split(h).join(t)+t+h,s=t+s,r={},i){for(i=u.split(h).join(t),c=0,a=e.indexOf(i);0<=a;++c)a=e.indexOf(i,a+i.length);1<c&&(r[i]=c)}i=r}return h=e,(n=s).length&&(h+=""+n),h+"_"},y=e=>{var t=(e=e.substring(0,e.length-1)).split("");if(e=t[0],1<t.length)for(var n of t=t[1])e=(e=e.split(n)).join(e.pop());return C(e,0)};var C=(e,t=1)=>{var n=[['"',"'"],["':","!"],[",'","~"],["}",")","\\","\\"],["{","(","\\","\\"]],o=(e,t)=>e.replace(new RegExp(`${(t[2]?t[2]:"")+t[0]}|${(t[3]?t[3]:"")+t[1]}`,"g"),(e=>e===t[0]?t[1]:t[0]));if(t)for(t=0;t<n.length;++t)e=o(e,n[t]);else for(t=n.length;t--;)e=o(e,n[t]);return e};const b={isNode:"a",shape:"b",value:"c",background:"d",stroke:"e",x:"f",y:"g",width:"h",height:"i",lineWeight:"j",dash:"k",startHead:"l",endHead:"m",segments:"o",type:"p",relative:"q",start:"r",end:"s",groups:"t",name:"u",node:"v",elements:"w",nodeIndex:"x",color:"y"};class E{static importURL(e){const t=new URL(e).searchParams.get("chart");if(!t)return;const n=this.paramToObject(t),o=this.unmangle(n),s=r.flowchart;for(const e of s.groups)s.deleteGroup(e);for(const e of o.groups){const t=s.createGroup();t.name=e.name,s.addGroup(t);for(const n of e.elements)n.isNode?this.importNode(s,t,n):this.importConnector(s,t,n);this.resolveRelatives(o,t)}}static importNode(e,t,n){const o=e.createNode({shape:n.shape});o.setValue(n.value),o.rect.x=n.x,o.rect.y=n.y,o.rect.width=n.width,o.rect.height=n.height,o.background=n.background,o.stroke=n.stroke,o.updateDom(),t.addNode(o)}static importConnector(e,t,n){function o(e){if("free"==e.type){return new v.FreeSegmentPoint(e.x,e.y)}{const t=new v.NodeEdgeSegmentPoint(null,e.relative);return t.nodeIndex=e.nodeIndex,t}}const s=[];for(const e of n.segments){const t=o(e.start),n=o(e.end),i=new v.Segment(t,n);s.push(i)}for(let e=0;e<s.length-1;e++)s[e].end=s[e+1].start;const i=e.createConnector({segments:s});i.color=n.color,i.setLineWeight(n.lineWeight),i.setDash(n.dash),i.setStartHead(n.startHead),i.setEndHead(n.endHead),t.addConnector(i)}static resolveRelatives(e,t){for(const e of t.connectors){for(const n of e.segments)for(const e of[n.start,n.end])if(e instanceof v.NodeEdgeSegmentPoint){const n=t.nodes[e.nodeIndex];e.node=n}e.createDomControl(),e.updateDom()}}static exportURL(e){const t={groups:[]};for(const n of e.groups){const e={name:n.name,elements:[]},o=Array.from(n.dom.children).map((e=>e.fElement)).filter((e=>e instanceof v.Node));for(const t of n.dom.children){let n;n=t.isNode?this.getNodeOutput(t.fElement):this.getConnectorOutput(t.fElement,o),e.elements.push(n)}t.groups.push(e)}const n=this.mangle(t);return`https://takaon.net/chart/?chart=${this.objectToParam(n)}`}static getNodeOutput(e){return{isNode:!0,shape:e.shape,value:e.value,background:e.background,stroke:e.stroke,x:Math.round(e.rect.x),y:Math.round(e.rect.y),width:Math.round(e.rect.width),height:Math.round(e.rect.height)}}static getConnectorOutput(e,t){const n={color:e.color,lineWeight:e.lineWeight,dash:e.dash,startHead:e.startHead,endHead:e.endHead,segments:[]};for(const o of e.segments){const e=e=>{if(e instanceof v.FreeSegmentPoint)return{type:"free",x:Math.round(e.x),y:Math.round(e.y)};return{type:"nodeEdge",nodeIndex:t.indexOf(e.node),relative:e.relative}};n.segments.push({start:e(o.start),end:e(o.end)})}return n}static mangle(e){if(!(null!=e&&"object"==typeof e))return e;let t;if(Array.isArray(e)){t=[];for(const n of e){const e=this.mangle(n);t.push(e)}}else{t={};for(const n in e){const o=this.mangle(e[n]);t[b[n]]=o}}return t}static unmangle(e){const t=this.getUnmangles();if(!(null!=e&&"object"==typeof e))return e;let n;if(Array.isArray(e)){n=[];for(const t of e){const e=this.unmangle(t);n.push(e)}}else{n={};for(const o in e){const s=this.unmangle(e[o]);n[t[o]]=s}}return n}static getUnmangles(){const e={};for(const t in b){e[b[t]]=t}return e}static objectToParam(e){const t=w.Bc(e),n=JSON.stringify(t),o=x(n),s=unescape(encodeURIComponent(o)),i=window.btoa(s);return encodeURIComponent(i)}static paramToObject(e){const t=window.atob(decodeURIComponent(e)),n=decodeURIComponent(escape(t)),o=y(n),s=JSON.parse(o);return w.mF(s)}}const S=document.getElementById("toolbar"),k=document.getElementById("toolbarFile"),L=document.getElementById("toolbarCopy"),T=document.getElementById("toolbarDelete"),N=document.getElementById("toolbarSnapCheckbox"),M=document.getElementById("toolbarGridCheckbox"),P=document.getElementById("tabs"),I=document.getElementById("tabAddGroup"),D=document.getElementById("context"),_=document.getElementById("contextNode"),R=document.getElementById("contextNodeBackgroundColor"),B=document.getElementById("contextNodeStrokeCheckbox"),O=document.getElementById("contextConnector"),A=document.getElementById("contextConnectorColor"),$=document.getElementById("contextConnectorAddPoint"),U=document.getElementById("contextConnectorDeletePoint"),X=document.getElementById("contextConnectorReverse"),H=document.getElementById("contextConnectorLineWeightSelect"),Y=document.getElementById("contextConnectorDashSelect"),j=document.getElementById("contextConnectorStartHeadCheckbox"),G=document.getElementById("contextConnectorEndHeadCheckbox"),F=document.getElementById("contextCommonMoveToFront"),V=document.getElementById("contextCommonMoveToBack"),W=(document.getElementById("flowchartArea"),document.getElementById("flowchartGrid"),document.getElementById("flowchartBack")),z=document.getElementById("flowchartRect"),K=document.getElementById("palette"),q=document.getElementById("shareUrlDialog"),J=document.getElementById("shareUrlDialogUrlCopy"),Q=document.getElementById("shareUrlDialogUrlTextarea"),Z=document.getElementById("shareUrlDialogOk");window.addEventListener("wheel",(e=>{e.preventDefault()}),{passive:!1}),r.flowchart=new v(z),z.appendChild(r.flowchart.dom),function(){for(const e of S.children)e.className.includes("toolbar-item")&&(e.addEventListener("pointerdown",(()=>{e.style.color="var(--icon-color-hover)"})),e.addEventListener("pointerup",(()=>{e.style.color=""})));k.addEventListener("click",(async()=>{switch(await n.dropdown(k,["保存用URLを取得","現在のページを書き出し (SVG)","現在のページを書き出し (PNG)"])){case 0:{const e=E.exportURL(r.flowchart);Q.value=e,J.onclick=()=>{navigator.clipboard.writeText(e),J.innerText="check"},Z.onclick=()=>{q.close()},J.innerText="content_copy",q.showModal()}break;case 1:{r.group.selected&&r.group.selected.unselect();const e=s.exportToSvg(r.flowchart.group),t=s.svgToUrl(e),n=document.createElement("a");n.href=t,n.download=`${r.flowchart.group.name}.svg`,n.click();break}case 2:{r.group.selected&&r.group.selected.unselect();const e=(await s.exportToImage(r.flowchart.group)).toDataURL(),t=document.createElement("a");t.href=e,t.download=`${r.flowchart.group.name}.png`,t.click();break}}})),L.addEventListener("click",(()=>{if(r.group.selected){const e=r.group.selected;if(r.group.selected instanceof v.Node){const t=r.flowchart.createNode({shape:e.shape});t.setValue(e.value),t.rect.x=e.rect.x+10,t.rect.y=e.rect.y+10,t.rect.width=e.rect.width,t.rect.height=e.rect.height,r.group.addNode(t),t.onclick()}else{const t=[];for(const n of e.segments){const e=new v.FreeSegmentPoint(n.start.x+10,n.start.y+10),o=new v.FreeSegmentPoint(n.end.x+10,n.end.y+10),s=new v.Segment(e,o);t.push(s)}const n=r.flowchart.createConnector({segments:t});r.group.addConnector(n),n.onclick(0,0)}}})),T.addEventListener("click",(()=>{if(r.group.selected){const e=r.group.selected;e.unselect(),e instanceof v.Node?r.group.deleteNode(e):r.group.deleteConnector(e)}r.group.repaint()})),N.addEventListener("change",(()=>{r.flowchart.snap=N.checked})),M.addEventListener("change",(()=>{r.flowchart.gridEnabled=M.checked,r.group.repaint()}))}(),function(){function e(){const e="新しいページ",n=document.createElement("div");n.className="tab";const s=document.createElement("span");s.innerText=e,n.name=s,n.appendChild(s);const i=document.createElement("span");i.innerText=e,i.contentEditable=!0,i.hidden=!0,n.editable=i,n.appendChild(i);const c=document.createElement("span");c.className="icon",c.innerText="close",n.close=c,n.appendChild(c),c.addEventListener("click",(e=>{!function(e){r.flowchart.deleteGroup(r.group),P.removeChild(e),o();t(P.children[P.children.length-1])}(n),e.stopPropagation()})),n.addEventListener("click",(()=>{t(n)})),s.addEventListener("click",(()=>{s.hidden=!0,i.hidden=!1}));const a=()=>{s.hidden=!1,i.hidden=!0,s.innerText=i.innerText,n.group.name=s.innerText};return i.addEventListener("keydown",(e=>{"Enter"==e.key&&a()})),i.addEventListener("focusout",(()=>{a()})),n.group=r.flowchart.createGroup(),n.group.name=e,r.flowchart.addGroup(n.group),P.appendChild(n),o(),t(n),n}function t(e){for(const t of P.children)t!=e&&t.group==r.group&&n(t);r.flowchart.selectGroup(e.group),e.className="tab tab-selected"}function n(e){e.name.hidden=!1,e.editable.hidden=!0,e.className="tab"}function o(){if(1==P.children.length)P.children[0].close.hidden=!0;else for(const e of P.children)e.close.hidden=!1}P.update=o,I.addEventListener("click",(()=>{e()})),e()}(),function(){const e=["#000000","#dc143c","#ff8c00","#008080","#17178a"],t=["#ffffff","#fdc9d0","#fde9d0","#cde6c7","#cfebf6"];function n(e,t,n){for(const o of t){const t=document.createElement("div");t.style.background=o,e.appendChild(t),t.addEventListener("click",(()=>{for(const t of e.children)t.style.outline="none";t.style.outline="2px solid var(--icon-color)",n(o)}))}e.children[0].style.outline="2px solid var(--icon-color)"}n(A,e,(e=>{r.group.selected.color=e,r.group.selected.updateDom()})),n(R,t,(e=>{r.group.selected.background=e,r.group.selected.updateDom()})),r.flowchart.onselectchange=n=>{const o=!n,s=n instanceof v.Connector,i=n instanceof v.Node;if(D.hidden=o,_.hidden=!i,O.hidden=!s,i){const e=Math.max(t.indexOf(n.background),0);R.children[e].click(),B.checked="transparent"!=n.stroke}if(s){const t=Math.max(e.indexOf(n.color),0);createConnectorColor.children[t].click(),j.checked=n.startHead,G.checked=n.endHead,H.value=n.lineWeight,Y.value=n.dash}},B.addEventListener("change",(e=>{r.group.selected.stroke=e.target.checked?"black":"transparent",r.group.selected.updateDom()})),j.addEventListener("change",(e=>{r.group.selected.setStartHead(e.target.checked)})),G.addEventListener("click",(e=>{r.group.selected.setEndHead(e.target.checked)})),X.addEventListener("click",(()=>{r.group.selected.reverse()})),Y.addEventListener("change",(e=>{r.group.selected.setDash("true"==e.target.value)})),H.addEventListener("change",(e=>{r.group.selected.setLineWeight(e.target.value)})),$.addEventListener("click",(()=>{r.group.selected.addPoint()})),U.addEventListener("click",(()=>{const e=r.group.selected;e instanceof v.Connector&&e.deletePoint()})),F.addEventListener("click",(()=>{r.group.selected&&r.group.moveToFront(r.group.selected)})),V.addEventListener("click",(()=>{r.group.selected&&r.group.moveToBack(r.group.selected)}))}(),function(){const e=Number.parseFloat(getComputedStyle(K).width),t=.3*e,n=["connector","text","connect","rect","subroutine","loopstart","loopend","switch","database","io"],o=["","","端子","矩形","定義済み処理","ループ開始","ループ終了","条件分岐","データベース","入出力"];for(const s of n){const i="connector"==s,c=document.createElement("div");let d;switch(c.style.width=`${e}px`,c.style.height=`${t}px`,s){case"connector":{const t=document.createElement("label");t.innerText="コネクタ",c.appendChild(t),d=a.generateConnectorSvg({start:{x:0,y:0},end:{x:.7*e,y:0},endHead:!0,disablePosition:!0});break}case"text":{const n=document.createElement("label");n.innerText="テキスト",c.appendChild(n),d=a.generateNodeSvg("rect",.7*e,.7*t,{background:"transparent",stroke:"transparent"});break}default:{const i=document.createElement("label");i.innerText=o[n.indexOf(s)],c.appendChild(i),d=a.generateNodeSvg(s,.7*e,.7*t)}}c.appendChild(d),K.appendChild(c),c.addEventListener("pointerdown",(()=>{c.style.background="#aaaaaa"})),c.addEventListener("pointerup",(()=>{c.style.background="unset";let e=r.flexibox.viewRect.centerX/r.flowchart.scale,t=r.flexibox.viewRect.centerY/r.flowchart.scale;if(e+=40*Math.random()-20,t+=40*Math.random()-20,i){const n=r.flowchart.createConnector({start:{x:e-30,y:t},end:{x:e+30,y:t}});r.group.addConnector(n)}else{const n=r.flowchart.createNode({shape:"text"==s?"rect":s});n.rect.x=e-n.rect.width/2,n.rect.y=t-n.rect.height/2,"text"==s&&(n.stroke="transparent",n.background="#ffffff",n.setValue("テキスト"),n.updateDom()),r.group.addNode(n)}}))}}(),W.addEventListener("pointerdown",(e=>{e.target.isNode||r.group.selected?.unselect()})),function(){E.importURL(location.href),r.flowchart.selectGroup(r.flowchart.groups[0]);for(const e of r.flowchart.groups){I.click();const t=P.lastChild;r.flowchart.deleteGroup(t.group),t.group=e,t.name.innerText=e.name,t.editable.innerText=e.name}P.removeChild(P.firstChild),P.firstChild.click(),P.update()}()})();